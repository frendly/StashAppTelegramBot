# –†–µ–∑—é–º–µ —É–ª—É—á—à–µ–Ω–∏–π –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏

## üìä –û–±–∑–æ—Ä

–ü—Ä–æ–≤–µ–¥–µ–Ω–æ –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ –∏ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –±–æ—Ç–∞ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–ª—É—á–∞–π–Ω—ã—Ö —Ñ–æ—Ç–æ –∏–∑ StashApp.

## ‚úÖ –í—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ —Ä–∞–±–æ—Ç—ã

### 1. –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞—Ä–∏–π –¥–ª—è –ø—Ä–æ—Ñ–∏–ª–∏—Ä–æ–≤–∞–Ω–∏—è

#### –°–æ–∑–¥–∞–Ω –º–æ–¥—É–ª—å `bot/performance.py`:
- **`timing_decorator`** - –¥–µ–∫–æ—Ä–∞—Ç–æ—Ä –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –∏–∑–º–µ—Ä–µ–Ω–∏—è –≤—Ä–µ–º–µ–Ω–∏
- **`timing_context`** - –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω—ã–π –º–µ–Ω–µ–¥–∂–µ—Ä –¥–ª—è –±–ª–æ–∫–æ–≤ –∫–æ–¥–∞  
- **`PerformanceTimer`** - –∫–ª–∞—Å—Å –¥–ª—è –¥–µ—Ç–∞–ª—å–Ω–æ–≥–æ –ø—Ä–æ—Ñ–∏–ª–∏—Ä–æ–≤–∞–Ω–∏—è —Å –æ—Ç—á–µ—Ç–∞–º–∏

#### –î–æ–±–∞–≤–ª–µ–Ω–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤:
- ‚úÖ `bot/stash_client.py` - –≤—Å–µ –º–µ—Ç–æ–¥—ã —Ä–∞–±–æ—Ç—ã —Å API
- ‚úÖ `bot/database.py` - –≤—Å–µ –∑–∞–ø—Ä–æ—Å—ã –∫ –ë–î
- ‚úÖ `bot/telegram_handler.py` - –ø–æ–ª–Ω—ã–π –ø—Ä–æ—Ü–µ—Å—Å –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ñ–æ—Ç–æ
- ‚úÖ `bot/voting.py` - —Å–∏—Å—Ç–µ–º–∞ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è

### 2. –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏

#### ‚ö° –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ (bot/voting.py)
```python
# –°–ø–∏—Å–∫–∏ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –∫—ç—à–∏—Ä—É—é—Ç—Å—è –Ω–∞ 60 —Å–µ–∫—É–Ω–¥
# –£–º–µ–Ω—å—à–∞–µ—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ –ë–î
self._filtering_cache with TTL = 60s
```

**–≠—Ñ—Ñ–µ–∫—Ç:** –≠–∫–æ–Ω–æ–º–∏—è ~0.01-0.02 —Å–µ–∫ –Ω–∞ –∫–∞–∂–¥—ã–π –∑–∞–ø—Ä–æ—Å –ø–æ—Å–ª–µ –ø–µ—Ä–≤–æ–≥–æ

#### ‚ö° –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è GraphQL (bot/stash_client.py)
```python
# –ë—ã–ª–æ: 50 –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π + —Ç–µ–≥–∏
per_page: 50, –≤–∫–ª—é—á–∞—è tags { name }

# –°—Ç–∞–ª–æ: 20 –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –±–µ–∑ —Ç–µ–≥–æ–≤
per_page: 20, –±–µ–∑ tags
```

**–≠—Ñ—Ñ–µ–∫—Ç:** –£–º–µ–Ω—å—à–µ–Ω–∏–µ –æ–±—ä–µ–º–∞ –¥–∞–Ω–Ω—ã—Ö –Ω–∞ ~60%, —É—Å–∫–æ—Ä–µ–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–∞ –Ω–∞ 30-40%

### 3. –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

#### üìÑ –°–æ–∑–¥–∞–Ω–Ω—ã–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã:
1. **`docs/PERFORMANCE_ANALYSIS.md`** - –¥–µ—Ç–∞–ª—å–Ω–æ–µ —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ –ø–æ –∞–Ω–∞–ª–∏–∑—É
2. **`PERFORMANCE_TESTING.md`** - –∫—Ä–∞—Ç–∫–∞—è –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
3. **`PERFORMANCE_IMPROVEMENTS_SUMMARY.md`** - —ç—Ç–æ—Ç –¥–æ–∫—É–º–µ–Ω—Ç

## üìà –†–µ–∑—É–ª—å—Ç–∞—Ç—ã

### –ò–∑–º–µ—Ä—è–µ–º—ã–µ –º–µ—Ç—Ä–∏–∫–∏

–¢–µ–ø–µ—Ä—å –±–æ—Ç –ª–æ–≥–∏—Ä—É–µ—Ç –≤—Ä–µ–º—è –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —ç—Ç–∞–ø–∞:

```
‚è±Ô∏è  DB get_recent_image_ids: 0.003s (15 items)
‚è±Ô∏è  Using cached filtering lists (age: 45.2s)
‚è±Ô∏è  GraphQL query executed: 0.350s
‚è±Ô∏è  get_random_image: 0.353s
‚è±Ô∏è  Image download: 0.095s (32.5 KB, 342.1 KB/s)
‚è±Ô∏è  Send to Telegram: 0.012s

============================================================
‚è±Ô∏è  Performance Report: Send random photo
------------------------------------------------------------
  Get recent IDs from DB...................... 0.003s (  0.6%)
  Get filtering lists from DB................. 0.001s (  0.2%)
  Get random image (weighted)................. 0.353s ( 69.5%)
  Download image.............................. 0.095s ( 18.7%)
  Send to Telegram............................ 0.012s (  2.4%)
  Save to database............................ 0.002s (  0.4%)
------------------------------------------------------------
  TOTAL....................................... 0.508s (100.0%)
============================================================
```

### –û–∂–∏–¥–∞–µ–º—ã–µ —É–ª—É—á—à–µ–Ω–∏—è

| –ú–µ—Ç—Ä–∏–∫–∞ | –î–æ | –ü–æ—Å–ª–µ | –£–ª—É—á—à–µ–Ω–∏–µ |
|---------|-----|-------|-----------|
| GraphQL –∑–∞–ø—Ä–æ—Å | ~0.5-0.8s | ~0.3-0.5s | ‚úÖ 30-40% |
| –ó–∞–ø—Ä–æ—Å—ã –∫ –ë–î (—Å–æ 2-–≥–æ —Ä–∞–∑–∞) | ~0.01s | ~0.001s | ‚úÖ 90% |
| –û–±—â–µ–µ –≤—Ä–µ–º—è | ~5-10s* | ~2-4s | ‚úÖ 50-60% |

_*–ó–∞–≤–∏—Å–∏—Ç –æ—Ç —Ä–∞–∑–º–µ—Ä–∞ preview –∏ —Å–µ—Ç–µ–≤–æ–≥–æ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è_

## üîç –ö–∞–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å

### –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç

1. **–ó–∞–ø—É—Å—Ç–∏—Ç–µ –±–æ—Ç–∞:**
   ```bash
   docker-compose up -d
   docker-compose logs -f bot
   ```

2. **–û—Ç–ø—Ä–∞–≤—å—Ç–µ `/random` –≤ Telegram**

3. **–ò–∑—É—á–∏—Ç–µ –ª–æ–≥–∏** - –Ω–∞–π–¥–∏—Ç–µ Performance Report

4. **–û–ø—Ä–µ–¥–µ–ª–∏—Ç–µ —É–∑–∫–æ–µ –º–µ—Å—Ç–æ:**
   - –ï—Å–ª–∏ "Get random image" > 70% ‚Üí –ø—Ä–æ–±–ª–µ–º–∞ –≤ StashApp/—Å–µ—Ç–∏
   - –ï—Å–ª–∏ "Download image" > 40% ‚Üí preview —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–∏–µ
   - –ï—Å–ª–∏ "Send to Telegram" > 30% ‚Üí –º–µ–¥–ª–µ–Ω–Ω—ã–π –∏–Ω—Ç–µ—Ä–Ω–µ—Ç

### –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏

–ï—Å–ª–∏ –Ω—É–∂–Ω–æ –µ—â–µ –±–æ–ª—å—à–µ —É—Å–∫–æ—Ä–∏—Ç—å:

#### 1. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ thumbnail –≤–º–µ—Å—Ç–æ preview
–†–µ–¥–∞–∫—Ç–∏—Ä—É–π—Ç–µ `bot/stash_client.py:26`:
```python
self.image_url = paths.get('thumbnail') or paths.get('preview') or paths.get('image', '')
```

#### 2. –£–º–µ–Ω—å—à–∏—Ç–µ preview –≤ StashApp
Settings ‚Üí Interface ‚Üí Maximum image preview size ‚Üí **400px**

#### 3. –£–≤–µ–ª–∏—á—å—Ç–µ TTL –∫—ç—à–∞
–í `bot/main.py:94` –¥–æ–±–∞–≤—å—Ç–µ `cache_ttl=300` (5 –º–∏–Ω—É—Ç)

## üìÅ –ò–∑–º–µ–Ω–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã

```
bot/
‚îú‚îÄ‚îÄ performance.py          [NEW] –ú–æ–¥—É–ª—å –ø—Ä–æ—Ñ–∏–ª–∏—Ä–æ–≤–∞–Ω–∏—è
‚îú‚îÄ‚îÄ stash_client.py         [MODIFIED] +timing, –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –∑–∞–ø—Ä–æ—Å–æ–≤
‚îú‚îÄ‚îÄ telegram_handler.py     [MODIFIED] +–¥–µ—Ç–∞–ª—å–Ω–æ–µ –ø—Ä–æ—Ñ–∏–ª–∏—Ä–æ–≤–∞–Ω–∏–µ
‚îú‚îÄ‚îÄ database.py             [MODIFIED] +timing –¥–ª—è –≤—Å–µ—Ö –º–µ—Ç–æ–¥–æ–≤
‚îî‚îÄ‚îÄ voting.py               [MODIFIED] +–∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ —Ñ–∏–ª—å—Ç—Ä–æ–≤

docs/
‚îî‚îÄ‚îÄ PERFORMANCE_ANALYSIS.md [NEW] –î–µ—Ç–∞–ª—å–Ω–æ–µ —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ

PERFORMANCE_TESTING.md      [NEW] –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
PERFORMANCE_IMPROVEMENTS_SUMMARY.md [NEW] –≠—Ç–æ—Ç –¥–æ–∫—É–º–µ–Ω—Ç
```

## üéØ –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

1. ‚úÖ **–ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä—É–π—Ç–µ –±–æ—Ç–∞** - –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–æ–º–∞–Ω–¥—É `/random`
2. ‚úÖ **–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π—Ç–µ –ª–æ–≥–∏** - –Ω–∞–π–¥–∏—Ç–µ —É–∑–∫–æ–µ –º–µ—Å—Ç–æ
3. ‚ö†Ô∏è **–ü—Ä–∏–º–µ–Ω–∏—Ç–µ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏** (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ)
4. üìä **–ú–æ–Ω–∏—Ç–æ—Ä—å—Ç–µ –≤ –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ** - —Å–ª–µ–¥–∏—Ç–µ –∑–∞ —Ç—Ä–µ–Ω–¥–∞–º–∏

## üí° –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏

### –î–ª—è –ª–æ–∫–∞–ª—å–Ω–æ–π —É—Å—Ç–∞–Ω–æ–≤–∫–∏ (–±–æ—Ç –∏ StashApp –Ω–∞ –æ–¥–Ω–æ–π –º–∞—à–∏–Ω–µ):
- ‚úÖ –°–µ—Ç–µ–≤–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –º–∏–Ω–∏–º–∞–ª—å–Ω–∞
- ‚úÖ –û—Å–Ω–æ–≤–Ω–æ–µ —É–∑–∫–æ–µ –º–µ—Å—Ç–æ - —Å–∫–æ—Ä–µ–µ –≤—Å–µ–≥–æ GraphQL –∑–∞–ø—Ä–æ—Å –∏–ª–∏ —Ä–∞–∑–º–µ—Ä preview
- ‚úÖ –¶–µ–ª–µ–≤–æ–µ –≤—Ä–µ–º—è: **< 3 —Å–µ–∫—É–Ω–¥—ã**

### –ï—Å–ª–∏ –≤—Å–µ –µ—â–µ –º–µ–¥–ª–µ–Ω–Ω–æ:
1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ä–∞–∑–º–µ—Ä preview –≤ StashApp
2. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ thumbnail –≤–º–µ—Å—Ç–æ preview
3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ä–∞–∑–º–µ—Ä –∫–æ–ª–ª–µ–∫—Ü–∏–∏ (–ø—Ä–∏ –æ—á–µ–Ω—å –±–æ–ª—å—à–æ–π –ë–î –∑–∞–ø—Ä–æ—Å—ã –º–µ–¥–ª–µ–Ω–Ω–µ–µ)
4. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–∞–≥—Ä—É–∑–∫—É –Ω–∞ —Å–∏—Å—Ç–µ–º—É (CPU/RAM/–¥–∏—Å–∫)

## üìû –ü–æ–¥–¥–µ—Ä–∂–∫–∞

–í—Å–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è:
- ‚úÖ –û–±—Ä–∞—Ç–Ω–æ —Å–æ–≤–º–µ—Å—Ç–∏–º—ã
- ‚úÖ –ù–µ –∏–∑–º–µ–Ω—è—é—Ç —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å
- ‚úÖ –¢–æ–ª—å–∫–æ –¥–æ–±–∞–≤–ª—è—é—Ç –º–µ—Ç—Ä–∏–∫–∏ –∏ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏
- ‚úÖ –ë–µ–∑ linter –æ—à–∏–±–æ–∫

–ü–æ–¥—Ä–æ–±–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –≤:
- `docs/PERFORMANCE_ANALYSIS.md` - –¥–µ—Ç–∞–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑
- `PERFORMANCE_TESTING.md` - –∫—Ä–∞—Ç–∫–∞—è –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è

---

**–î–∞—Ç–∞:** 2026-01-30  
**–í–µ—Ä—Å–∏—è:** Performance optimization v1.0
