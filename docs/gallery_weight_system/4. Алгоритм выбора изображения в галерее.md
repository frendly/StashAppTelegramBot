# 4. Алгоритм выбора изображения в галерее

**Приоритет:** Высокий (Core функциональность)

## Описание
Реализация алгоритма выбора изображения внутри галереи с приоритетами: 70% неоцененные, 20% с "+", 10% с "-".

## Требования из MVP
- 70% - неоцененные изображения
- 20% - изображения с "+"
- 10% - изображения с "-"

## Задачи

### 4.1. Определение статуса изображения
**Файл:** `bot/database.py`

Добавить метод:
- `get_image_vote_status(image_id)` - получение статуса голосования за изображение
- Возвращает: None (неоцененное), 1 (плюс), -1 (минус)

### 4.2. GraphQL запросы с фильтрацией по рейтингу
**Файл:** `bot/stash_client.py`

Модифицировать/добавить методы:
- `get_images_from_gallery_by_rating(gallery_id, rating_filter, exclude_ids)` - получение изображений с фильтром по рейтингу
- Фильтры:
  - Неоцененные: `rating100: null` или `rating100: 0`
  - С "+": `rating100: { value: 80, modifier: GREATER_THAN }` (rating >= 4/5)
  - С "-": `rating100: { value: 20, modifier: LESS_THAN }` (rating <= 1/5)

### 4.3. Алгоритм выбора с приоритетами
**Файл:** `bot/stash_client.py`

Создать метод:
- `get_random_image_from_gallery_weighted(gallery_id, exclude_ids)` - выбор изображения с учетом приоритетов
- Алгоритм:
  1. Сгенерировать случайное число от 0 до 99
  2. Если 0-69 → категория "неоцененные" (70%)
  3. Если 70-89 → категория "с +" (20%)
  4. Если 90-99 → категория "с -" (10%)
  5. Попытаться получить изображение из выбранной категории
  6. Если в категории нет изображений, fallback на другую категорию:
     - Приоритет fallback: неоцененные > с + > с -

### 4.4. Интеграция в выбор изображения
**Файл:** `bot/telegram_handler.py`

Модифицировать `_get_random_image()`:
- После выбора галереи (задача 3) использовать `get_random_image_from_gallery_weighted()`
- Учитывать exclude_ids (недавно отправленные)

## Тестирование
- Проверить распределение: ~70% неоцененных, ~20% с "+", ~10% с "-"
- Проверить fallback при отсутствии изображений в категории
- Проверить исключение недавно отправленных изображений

## Зависимости
- Задача 3: Взвешенный случайный выбор галереи

## Безопасность релиза

### ✅ Можно релизить после этой задачи

**Условия для безопасного релиза:**
1. Алгоритм выбора изображения в галерее работает только если галерея уже выбрана (задача 3)
2. Если в выбранной категории нет изображений, используется fallback на другую категорию
3. Если все категории пустые, возвращается `None` (обрабатывается как раньше)

**Fallback-механизмы:**
- Приоритет fallback: неоцененные > с "+" > с "-"
- Если в категории нет изображений, пробуем следующую
- Если все категории пустые, возвращаем `None` (как в старом методе)

**Проверка перед релизом:**
- [ ] Бот запускается без ошибок
- [ ] Команда `/random` работает
- [ ] Выбор изображений работает (даже если категории пустые)
- [ ] Fallback на другую категорию работает корректно

**Что НЕ сломается:**
- Выбор изображений (есть fallback между категориями)
- Голосование (работает как раньше)
- Все остальные функции

## Связанные задачи
- Нет
