# 13. Кэширование весов галерей

**Приоритет:** Низкий (Оптимизация)

## Описание
Оптимизация производительности через кэширование весов галерей для взвешенного выбора.

## Требования из MVP
- Кэширование весов галерей
- Индексы в БД
- Взвешенный случайный выбор с оптимизацией

## Задачи

### 13.1. Индексы в БД
**Файл:** `bot/database.py`

В `_init_database()`:
- Создать индекс на `gallery_preferences.weight` для быстрой выборки
- Создать индекс на `gallery_preferences.excluded` для фильтрации
- Создать составной индекс `(excluded, weight)` для выборки активных галерей

### 13.2. Кэш весов в VotingManager
**Файл:** `bot/voting.py`

Расширить существующий кэш:
- Добавить кэш весов галерей: `_gallery_weights_cache`
- TTL для кэша весов (например, 60 секунд)
- Метод `get_gallery_weights_cached()` - получение весов с кэшированием

### 13.3. Инвалидация кэша
**Файл:** `bot/voting.py`

В `process_vote()`:
- После обновления веса галереи инвалидировать кэш весов
- Вызывать `invalidate_gallery_weights_cache()`

### 13.4. Метод получения весов с кэшем
**Файл:** `bot/database.py` или `bot/voting.py`

Создать метод:
- `get_active_gallery_weights_cached()` - получение весов активных галерей с кэшированием
- Проверять кэш перед запросом к БД
- Обновлять кэш при истечении TTL

### 13.5. Оптимизация запроса весов
**Файл:** `bot/database.py`

В `get_active_gallery_weights()`:
- Использовать индекс для быстрой выборки
- Выбирать только необходимые поля (gallery_id, weight)
- Фильтровать excluded = FALSE в SQL

## Тестирование
- Проверить работу кэша (не запрашивать БД при повторных вызовах)
- Проверить инвалидацию кэша при обновлении веса
- Проверить производительность (время выборки)
- Проверить использование индексов (EXPLAIN QUERY PLAN)

## Зависимости
- Задача 1: Система весов галерей
- Задача 3: Взвешенный случайный выбор галереи

## Безопасность релиза

### ✅ Можно релизить после этой задачи

**Условия для безопасного релиза:**
1. Кэширование - это оптимизация, не критично для работы
2. Если кэш не работает, система использует прямой запрос к БД (как раньше)
3. Индексы в БД не ломают существующие запросы

**Fallback-механизмы:**
- Если кэш не инициализирован → используется прямой запрос к БД
- Если кэш истек → автоматически обновляется из БД
- Если произошла ошибка кэша → используется прямой запрос к БД

**Проверка перед релизом:**
- [ ] Бот запускается без ошибок
- [ ] Команда `/random` работает
- [ ] Кэш работает (проверить логи на повторные запросы)
- [ ] Инвалидация кэша работает при обновлении веса
- [ ] Производительность улучшилась (опционально)

**Что НЕ сломается:**
- Выбор изображений (работает даже без кэша)
- Голосование (работает как раньше)
- Все остальные функции

**Примечание:** Это оптимизация, система работает и без нее, но медленнее.

## Связанные задачи
- Нет
