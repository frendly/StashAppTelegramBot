# 7. Пороги исключения

**Приоритет:** Средний (Core логика)

## Описание
Реализация логики определения порогов исключения галерей на основе количества изображений и процента минусов.

## Требования из MVP
- Галерея с 1 изображением: 1 минус → показывать кнопку исключения
- Галерея с 2 изображениями: 1 минус → показывать кнопку исключения
- Галерея с 3+ изображениями: ≥33.3% минусов → показывать кнопку исключения

## Задачи

### 7.1. Функция проверки порога
**Файл:** `bot/database.py` или `bot/voting.py`

Создать функцию:
- `check_exclusion_threshold(gallery_id)` - проверка достижения порога исключения
- Получить статистику галереи (total_images, negative_votes)
- Обработать edge case: если total_images == 0, вернуть (False, 0.0)
- Применить логику порогов:
  - Если total_images == 1 и negative_votes >= 1: True
  - Если total_images == 2 и negative_votes >= 1: True
  - Если total_images >= 3 и (negative_votes / total_images) >= 0.333: True
- Возвращает (bool, negative_percentage)

### 7.2. Интеграция в обработку голосования
**Файл:** `bot/voting.py`

Модифицировать `process_vote()`:
- После обновления статистики галереи вызывать `check_exclusion_threshold()`
- Возвращать в результате флаг `threshold_reached`

### 7.3. Проверка показа уведомления
**Файл:** `bot/database.py`

Добавить методы:
- `is_threshold_notification_shown(gallery_id)` - проверка, показывалось ли уведомление
- `mark_threshold_notification_shown(gallery_id)` - отметить, что уведомление показано

### 7.4. Обновление флага при восстановлении
**Файл:** `bot/database.py`

В методе восстановления галереи (задача 11):
- Сбросить `threshold_notification_shown = FALSE` при восстановлении

## Тестирование
- Проверить порог для галереи с 1 изображением (1 минус)
- Проверить порог для галереи с 2 изображениями (1 минус)
- Проверить порог для галереи с 3+ изображениями (≥33.3%)
- Проверить точность расчета процента (33.3% = 1/3)

## Зависимости
- Задача 2: Статистика галереи

## Безопасность релиза

### ✅ Можно релизить после этой задачи

**Условия для безопасного релиза:**
1. Проверка порога работает только если есть статистика (задача 2)
2. Если статистики нет, порог не проверяется (возвращает `False`)
3. Все вычисления защищены от деления на ноль
4. Проверка порога не блокирует работу системы

**Fallback-механизмы:**
- Если `total_images == 0` → возвращает `(False, 0.0)` (порог не достигнут)
- Если статистики нет → порог не проверяется (не критично)
- Если произошла ошибка → возвращает `(False, 0.0)` (безопасное значение)

**Проверка перед релизом:**
- [ ] Бот запускается без ошибок
- [ ] Голосование работает
- [ ] Проверка порога работает корректно для разных случаев (1, 2, 3+ изображения)
- [ ] Нет ошибок деления на ноль
- [ ] Если статистики нет, система продолжает работать

**Что НЕ сломается:**
- Голосование (работает как раньше)
- Выбор изображений (работает как раньше)
- Все остальные функции

## Связанные задачи
- Задача 6: Формат сообщений с информацией о галерее
- Задача 8: Кнопка исключения галереи
- Задача 9: Уведомления о достижении порога
