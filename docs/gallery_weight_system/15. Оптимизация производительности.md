# 15. Оптимизация производительности

**Приоритет:** Низкий (Оптимизация)

## Описание
Дополнительные оптимизации для работы с 300 галереями и ~5000 изображениями при 100 голосах/день.

## Требования из MVP
- 300 галерей, ~5000 изображений
- 100 голосов/день
- Оптимизации:
  - Кэширование весов галерей
  - Индексы в БД
  - Взвешенный случайный выбор с оптимизацией

## Задачи

### 15.1. Дополнительные индексы БД
**Файл:** `bot/database.py`

Добавить индексы:
- `idx_gallery_preferences_excluded_weight` - составной индекс для выборки активных галерей
- `idx_votes_gallery_id` - индекс на votes.gallery_id для быстрой выборки голосов по галерее
- `idx_gallery_preferences_updated_at` - индекс для сортировки по дате обновления

### 15.2. Оптимизация GraphQL запросов
**Файл:** `bot/stash_client.py`

Оптимизировать запросы:
- Минимизировать поля в запросах (только необходимые)
- Использовать пагинацию эффективно
- Кэшировать результаты запросов к StashApp (где возможно)

### 15.3. Батчинг обновлений БД
**Файл:** `bot/database.py`

Для массовых операций:
- Использовать транзакции для батчинга
- Обновлять несколько записей за один запрос (где возможно)

### 15.4. Оптимизация выборки весов
**Файл:** `bot/database.py`

В `get_active_gallery_weights()`:
- Использовать только необходимые поля
- Избегать лишних JOIN (если появятся)
- Использовать LIMIT, если нужен топ-N

### 15.5. Мониторинг производительности
**Файл:** `bot/performance.py` (существующий)

Расширить мониторинг:
- Логирование времени выполнения критических операций
- Метрики для выборки весов
- Метрики для взвешенного выбора

### 15.6. Ленивая загрузка статистики
**Файл:** `bot/telegram_handler.py`

Оптимизировать `_format_caption()`:
- Загружать статистику галереи только если нужно показать прогресс-бар
- Кэшировать статистику для текущего изображения

## Тестирование
- Проверить производительность с большим количеством галерей (300+)
- Проверить время выборки весов
- Проверить время взвешенного выбора
- Проверить использование индексов (EXPLAIN QUERY PLAN)
- Нагрузочное тестирование (100+ голосов)

## Зависимости
- Задача 1: Система весов галерей
- Задача 3: Взвешенный случайный выбор галереи
- Задача 13: Кэширование весов галерей

## Безопасность релиза

### ✅ Можно релизить после этой задачи

**Условия для безопасного релиза:**
1. Оптимизации не изменяют функциональность, только производительность
2. Если оптимизация не работает, система работает как раньше (медленнее)
3. Индексы в БД не ломают существующие запросы

**Fallback-механизмы:**
- Если индекс не создан → запрос работает, но медленнее
- Если оптимизация не применена → система работает как раньше
- Все оптимизации обратно совместимы

**Проверка перед релизом:**
- [ ] Бот запускается без ошибок
- [ ] Все функции работают как раньше
- [ ] Производительность улучшилась (опционально, проверить метрики)
- [ ] Индексы созданы корректно

**Что НЕ сломается:**
- Выбор изображений (работает как раньше)
- Голосование (работает как раньше)
- Все остальные функции

**Примечание:** Это оптимизация, система работает и без нее, но может быть медленнее при больших объемах данных.

## Связанные задачи
- Нет
