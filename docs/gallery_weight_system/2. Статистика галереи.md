# 2. Статистика галереи

**Приоритет:** Высокий (Core функциональность)

## Описание
Хранение и обновление статистики по каждой галерее: общее количество изображений, количество "+" и "-", процент минусов.

## Требования из MVP
Для каждой галереи хранить:
- Общее количество изображений
- Количество "+"
- Количество "-"
- Процент минусов = (минусы / всего_изображений) × 100%

## Задачи

### 2.1. Расширение схемы БД
**Файл:** `bot/database.py`

Добавить в таблицу `gallery_preferences`:
- `total_images INTEGER DEFAULT 0` - общее количество изображений в галерее
- `images_count_updated_at TIMESTAMP` - дата последнего обновления количества

### 2.2. Методы работы со статистикой
**Файл:** `bot/database.py`

Добавить методы:
- `update_gallery_image_count(gallery_id, total_images)` - обновление количества изображений
- `get_gallery_statistics(gallery_id)` - получение полной статистики (включая процент минусов)
- `calculate_negative_percentage(gallery_id)` - расчет процента минусов

### 2.3. Получение количества изображений из StashApp
**Файл:** `bot/stash_client.py`

Добавить метод:
- `get_gallery_image_count(gallery_id)` - GraphQL запрос для получения количества изображений в галерее

GraphQL запрос:
```graphql
query GetGalleryImageCount($id: ID!) {
  findGallery(id: $id) {
    image_count
  }
}
```

### 2.4. Обновление статистики при голосовании
**Файл:** `bot/voting.py`

Модифицировать `process_vote()`:
- Проверить, нужно ли обновить количество изображений:
  - Если `total_images == 0` (первое голосование)
  - ИЛИ `images_count_updated_at` старше 7 дней
- Если нужно, запросить количество изображений из StashApp
- Сохранить в БД через `database.update_gallery_image_count()`
- При последующих голосованиях использовать кэшированное значение
- Периодически (раз в день/неделю) обновлять количество для всех галерей (задача 2.5)

### 2.5. Фоновая задача обновления статистики
**Файл:** `bot/scheduler.py` или новый `bot/gallery_stats_updater.py`

Создать периодическую задачу:
- Обновление количества изображений для всех галерей с голосами
- Запуск раз в день/неделю (настраиваемо)

## Тестирование
- Проверить получение количества изображений из StashApp
- Проверить сохранение в БД
- Проверить расчет процента минусов
- Проверить обновление при голосовании

## Зависимости
- Задача 1: Система весов галерей (для работы с таблицей gallery_preferences)

## Безопасность релиза

### ✅ Можно релизить после этой задачи

**Условия для безопасного релиза:**
1. Поле `total_images` имеет значение по умолчанию `0`
2. Статистика собирается постепенно (при первом голосовании за галерею)
3. Если статистики нет, система работает без нее (graceful degradation)
4. Запрос к StashApp для получения количества изображений выполняется асинхронно и не блокирует работу

**Fallback-механизмы:**
- Если `total_images == 0`, статистика не показывается (но не ломает работу)
- Если запрос к StashApp не удался, используется значение `0` (не критично)
- Старый функционал не изменяется, только добавляется сбор статистики

**Проверка перед релизом:**
- [ ] Бот запускается без ошибок
- [ ] Голосование работает
- [ ] При первом голосовании за галерею запрашивается количество изображений
- [ ] Статистика сохраняется в БД
- [ ] Если запрос к StashApp не удался, система продолжает работать

**Что НЕ сломается:**
- Выбор изображений (работает как раньше)
- Голосование (работает как раньше)
- Отображение (без статистики работает как раньше, до задачи 5)

## Связанные задачи
- Задача 3: Взвешенный случайный выбор галереи
- Задача 5: Прогресс-бар в подписи
- Задача 7: Пороги исключения
