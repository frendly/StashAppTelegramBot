# 9. Уведомления о достижении порога

**Приоритет:** Средний (UI)

## Описание
Реализация системы уведомлений о достижении порога 33.3% с показом один раз.

## Требования из MVP
- Пороговое уведомление: показывается один раз при достижении 33.3%
- После показа: кнопка остается, уведомление не повторяется
- При восстановлении: сброс состояния уведомления

## Задачи

### 9.1. Отслеживание показа уведомления
**Файл:** `bot/database.py`

Использовать поле `threshold_notification_shown` (добавлено в задаче 1):
- При достижении порога проверить флаг
- Если флаг FALSE - показать уведомление и установить TRUE
- Если флаг TRUE - не показывать уведомление, но показать кнопку

### 9.2. Логика показа уведомления
**Файл:** `bot/telegram_handler.py`

В `_send_random_photo()`:
- После получения изображения проверить порог через `_check_exclusion_threshold()`
- Проверить флаг `threshold_notification_shown`
- Если порог достигнут и уведомление не показывалось:
  - Использовать формат с уведомлением (задача 6)
  - Установить флаг через `database.mark_threshold_notification_shown()`
- Если порог достигнут, но уведомление уже показывалось:
  - Использовать обычный формат, но с кнопкой исключения

### 9.3. Обновление после голосования
**Файл:** `bot/telegram_handler.py`

В `handle_vote_callback()`:
- После обработки голоса проверить достижение порога
- Если порог только что достигнут (было <33.3%, стало ≥33.3%):
  - Отредактировать сообщение с уведомлением
  - Установить флаг показа уведомления

### 9.4. Сброс при восстановлении
**Файл:** `bot/database.py`

В методе восстановления галереи (задача 11):
- Сбросить `threshold_notification_shown = FALSE`
- Это позволит показать уведомление снова, если порог будет достигнут после восстановления

## Тестирование
- Проверить показ уведомления один раз при достижении порога
- Проверить, что уведомление не повторяется
- Проверить сохранение кнопки после показа уведомления
- Проверить сброс при восстановлении

## Зависимости
- Задача 1: Система весов галерей (поле threshold_notification_shown)
- Задача 6: Формат сообщений с информацией о галерее
- Задача 7: Пороги исключения
- Задача 11: Команда /restore (для сброса флага)

## Безопасность релиза

### ✅ Можно релизить после этой задачи

**Условия для безопасного релиза:**
1. Уведомление показывается только если порог достигнут (задача 7)
2. Если задача 7 не реализована, уведомление не показывается (безопасно)
3. Флаг `threshold_notification_shown` имеет значение по умолчанию `FALSE`
4. Уведомление не блокирует работу системы

**Fallback-механизмы:**
- Если задача 7 не реализована → уведомление не показывается
- Если порог не достигнут → уведомление не показывается
- Если флаг уже установлен → уведомление не показывается повторно (как задумано)

**Проверка перед релизом:**
- [ ] Бот запускается без ошибок
- [ ] Команда `/random` работает
- [ ] Уведомление показывается один раз при достижении порога
- [ ] Уведомление не повторяется при повторном показе изображения
- [ ] Кнопка исключения остается после показа уведомления

**Что НЕ сломается:**
- Отображение изображений (работает как раньше)
- Голосование (работает как раньше)
- Все остальные функции

## Связанные задачи
- Задача 8: Кнопка исключения галереи
