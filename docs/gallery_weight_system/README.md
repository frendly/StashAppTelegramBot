# План реализации MVP функциональности

Этот документ содержит детальный план реализации функциональности согласно техническому заданию в `mvp_plan.md`.

## Структура плана

План разбит на 15 задач, каждая в отдельном файле с номером и названием. Задачи приоритизированы от высокого к низкому приоритету.

## Приоритеты

### Высокий приоритет (Core функциональность)
Эти задачи должны быть реализованы в первую очередь, так как они составляют основу системы.

1. **Система весов галерей (k=0.2)** - базовая система весов с коэффициентом 0.2
2. **Статистика галереи** - хранение и обновление статистики (количество изображений, +/- голоса, процент минусов)
3. **Взвешенный случайный выбор галереи** - выбор галереи на основе весов
4. **Алгоритм выбора изображения в галерее** - приоритеты: 70% неоцененные, 20% с "+", 10% с "-"

### Средний приоритет (UI и логика)
Эти задачи добавляют пользовательский интерфейс и логику работы с порогами.

5. **Прогресс-бар в подписи к изображению** - визуализация процента минусов
6. **Формат сообщений с информацией о галерее** - обновление формата подписей
7. **Пороги исключения** - логика определения порогов (1 минус для 1-2 изображений, ≥33.3% для 3+)
8. **Кнопка исключения галереи** - функциональность исключения через кнопку
9. **Уведомления о достижении порога** - показ уведомления один раз при достижении 33.3%

### Низкий приоритет (Команды управления)
Эти задачи добавляют команды для управления исключенными галереями.

10. **Команда /excluded** - список исключенных галерей
11. **Команда /restore** - восстановление галереи
12. **Команда /threshold** - галереи по проценту минусов

### Низкий приоритет (Оптимизация и миграция)
Эти задачи улучшают производительность и добавляют инструменты миграции.

13. **Кэширование весов галерей** - оптимизация производительности
14. **Скрипт миграции для пересчета весов** - пересчет начальных весов из истории
15. **Оптимизация производительности** - дополнительные оптимизации

## Зависимости между задачами

```
1. Система весов
   ├─> 2. Статистика галереи
   ├─> 3. Взвешенный выбор
   │   └─> 4. Алгоритм выбора в галерее
   │
2. Статистика
   ├─> 5. Прогресс-бар
   ├─> 6. Формат сообщений
   ├─> 7. Пороги исключения
   │   ├─> 8. Кнопка исключения
   │   └─> 9. Уведомления
   │
7. Пороги
   ├─> 8. Кнопка исключения
   │   ├─> 10. Команда /excluded
   │   └─> 11. Команда /restore
   │
3. Взвешенный выбор
   └─> 13. Кэширование весов
       └─> 15. Оптимизация
```

## Рекомендуемый порядок реализации

### Фаза 1: Core функциональность (Задачи 1-4)
**Можно релизить после каждой задачи**

1. Система весов галерей (k=0.2) - ✅ Безопасно для релиза
2. Статистика галереи - ✅ Безопасно для релиза (после задачи 1)
3. Взвешенный случайный выбор галереи - ✅ Безопасно для релиза (с fallback)
4. Алгоритм выбора изображения в галерее - ✅ Безопасно для релиза (с fallback)

### Фаза 2: UI и пороги (Задачи 5-9)
**Можно релизить после каждой задачи (после фазы 1)**

5. Прогресс-бар в подписи к изображению - ✅ Безопасно для релиза
6. Формат сообщений с информацией о галерее - ✅ Безопасно для релиза
7. Пороги исключения - ✅ Безопасно для релиза
8. Кнопка исключения галереи - ✅ Безопасно для релиза (после задачи 7)
9. Уведомления о достижении порога - ✅ Безопасно для релиза (после задачи 7)

### Фаза 3: Команды управления (Задачи 10-12)
**Можно релизить после каждой задачи (после фазы 2)**

10. Команда /excluded - ✅ Безопасно для релиза (после задачи 8)
11. Команда /restore - ✅ Безопасно для релиза (после задачи 8)
12. Команда /threshold - ✅ Безопасно для релиза

### Фаза 4: Оптимизация (Задачи 13-15)
**Можно релизить в любое время (не критично для работы)**

13. Кэширование весов галерей - ✅ Безопасно для релиза (оптимизация)
14. Скрипт миграции для пересчета весов - ✅ Безопасно для релиза (утилита)
15. Оптимизация производительности - ✅ Безопасно для релиза (оптимизация)

## Безопасность релиза

### ✅ Все задачи готовы для релиза после каждой задачи

**См. также:** [RELEASE_CHECKLIST.md](RELEASE_CHECKLIST.md) - детальный чек-лист для релиза Docker образа после каждой задачи.

**Ключевые принципы:**
1. Каждая задача имеет fallback-механизмы для безопасной работы
2. Новый функционал не ломает существующий
3. Все изменения обратно совместимы
4. Проверки перед релизом описаны в каждой задаче

**Рекомендуемый workflow релиза:**
```bash
# После каждой задачи:
1. Реализовать задачу
2. Протестировать локально
3. Проверить чек-лист из раздела "Безопасность релиза"
4. Создать коммит и PR
5. После мерджа - создать Docker образ и протестировать в dev
6. Если все ок - релизить в production
```

**Порядок релиза по задачам:**
- Задачи 1-4: Core функциональность (можно релизить последовательно)
- Задачи 5-9: UI и пороги (можно релизить после задач 1-4)
- Задачи 10-12: Команды управления (можно релизить после задач 5-9)
- Задачи 13-15: Оптимизация (можно релизить в любое время, не критично)

## Важные замечания

1. **Миграция данных**: Перед запуском в продакшн рекомендуется выполнить скрипт миграции (задача 14) для пересчета весов существующих галерей. Но система работает и без него (веса = 1.0).

2. **Обратная совместимость**: Все новые поля в БД имеют значения по умолчанию. Существующие данные обрабатываются корректно.

3. **Тестирование**: Каждая задача содержит раздел "Тестирование" и "Безопасность релиза" с чек-листом для проверки.

4. **Производительность**: Учитывать требования MVP: 300 галерей, ~5000 изображений, 100 голосов/день. Оптимизации в задачах 13 и 15 улучшают производительность, но не критичны для работы.

5. **Fallback-механизмы**: Все критические функции имеют fallback на старые методы, если новый функционал не доступен.

## Файлы задач

- [1. Система весов галерей (k=0.2)](1.%20Система%20весов%20галерей%20(k=0.2).md)
- [2. Статистика галереи](2.%20Статистика%20галереи.md)
- [3. Взвешенный случайный выбор галереи](3.%20Взвешенный%20случайный%20выбор%20галереи.md)
- [4. Алгоритм выбора изображения в галерее](4.%20Алгоритм%20выбора%20изображения%20в%20галерее.md)
- [5. Прогресс-бар в подписи к изображению](5.%20Прогресс-бар%20в%20подписи%20к%20изображению.md)
- [6. Формат сообщений с информацией о галерее](6.%20Формат%20сообщений%20с%20информацией%20о%20галерее.md)
- [7. Пороги исключения](7.%20Пороги%20исключения.md)
- [8. Кнопка исключения галереи](8.%20Кнопка%20исключения%20галереи.md)
- [9. Уведомления о достижении порога](9.%20Уведомления%20о%20достижении%20порога.md)
- [10. Команда /excluded](10.%20Команда%20excluded%20-%20список%20исключенных%20галерей.md)
- [11. Команда /restore](11.%20Команда%20restore%20-%20восстановление%20галереи.md)
- [12. Команда /threshold](12.%20Команда%20threshold%20-%20галереи%20по%20проценту%20минусов.md)
- [13. Кэширование весов галерей](13.%20Кэширование%20весов%20галерей.md)
- [14. Скрипт миграции для пересчета весов](14.%20Скрипт%20миграции%20для%20пересчета%20весов.md)
- [15. Оптимизация производительности](15.%20Оптимизация%20производительности.md)

## Названия PR и коммитов

### Альтернативные варианты (более короткие)

#### Задача 1

**PR:** `feat: Gallery weight system (k=0.2)`  
**Коммиты:** `feat: Add gallery weight system with k=0.2`

#### Задача 2

**PR:** `feat: Gallery statistics tracking`  
**Коммиты:** `feat: Add gallery statistics (image count, votes, percentage)`

#### Задача 3

**PR:** `feat: Weighted gallery selection`  
**Коммиты:** `feat: Implement weighted random gallery selection`

#### Задача 4

**PR:** `feat: Weighted image selection (70/20/10)`  
**Коммиты:** `feat: Add weighted image selection within gallery`

#### Задача 5

**PR:** `feat: Progress bar in image captions`  
**Коммиты:** `feat: Add progress bar showing negative percentage`

#### Задача 6

**PR:** `feat: Update message format with gallery info`  
**Коммиты:** `feat: Update captions with gallery statistics`

#### Задача 7

**PR:** `feat: Gallery exclusion thresholds`  
**Коммиты:** `feat: Add exclusion threshold logic`

#### Задача 8

**PR:** `feat: Gallery exclusion button`  
**Коммиты:** `feat: Add gallery exclusion functionality`

#### Задача 9

**PR:** `feat: Threshold notifications`  
**Коммиты:** `feat: Add one-time threshold notifications`

#### Задача 10

**PR:** `feat: /excluded command`  
**Коммиты:** `feat: Add /excluded command`

#### Задача 11

**PR:** `feat: /restore command`  
**Коммиты:** `feat: Add /restore command`

#### Задача 12

**PR:** `feat: /threshold command`  
**Коммиты:** `feat: Add /threshold command`

#### Задача 13

**PR:** `perf: Cache gallery weights`  
**Коммиты:** `perf: Add gallery weights caching`

#### Задача 14

**PR:** `feat: Weight migration script`  
**Коммиты:** `feat: Add weight recalculation script`

#### Задача 15

**PR:** `perf: Performance optimizations`  
**Коммиты:** `perf: Add performance optimizations`
