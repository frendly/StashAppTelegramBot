# 14. Скрипт миграции для пересчета весов

> **Примечание:** Миграция выполнена. Этот документ сохранен для истории.

**Приоритет:** Низкий (Миграция данных)

## Описание
Создание скрипта для пересчета начальных весов всех существующих галерей из истории голосов.

## Требования из MVP
- Начальные веса: рассчитать из истории оценок по формуле: W = 1.0 * 1.2^(плюсы) * 0.8^(минусы)
- Применить ограничения: 0.1 ≤ вес ≤ 10.0

## Задачи

### 14.1. Создание скрипта миграции
**Файл:** `scripts/migrate_gallery_weights.py` (новый)

Создать скрипт:
- Подключение к БД
- Получение всех галерей из `gallery_preferences`
- Для каждой галереи:
  - Получить positive_votes и negative_votes
  - Рассчитать вес: W = 1.0 * 1.2^(плюсы) * 0.8^(минусы)
  - Применить ограничения: max(0.1, min(10.0, weight))
  - Обновить вес в БД
- Логирование прогресса

### 14.2. Функция расчета веса
**Файл:** `scripts/migrate_gallery_weights.py`

Создать функцию:
- `calculate_weight_from_history(positive_votes, negative_votes)` - расчет веса из истории
- Формула: `1.0 * (1.2 ** positive_votes) * (0.8 ** negative_votes)`
- Применение ограничений

### 14.3. Безопасность миграции
**Файл:** `scripts/migrate_gallery_weights.py`

Добавить:
- Проверку существования БД
- Резервное копирование перед миграцией (опционально)
- Подтверждение перед запуском
- Сухой прогон (dry-run) для проверки

### 14.4. Логирование
**Файл:** `scripts/migrate_gallery_weights.py`

Логировать:
- Количество обработанных галерей
- Примеры пересчитанных весов
- Ошибки (если есть)
- Время выполнения

### 14.5. Интеграция в Makefile
**Файл:** `Makefile`

Добавить команду:
- `make migrate-weights` - запуск миграции весов

## Тестирование
- Проверить расчет весов для тестовых данных
- Проверить применение ограничений
- Проверить корректность обновления в БД
- Проверить обработку галерей без голосов (вес = 1.0)

## Зависимости
- Задача 1: Система весов галерей (схема БД)

## Безопасность релиза

### ✅ Можно релизить после этой задачи

**Условия для безопасного релиза:**
1. Скрипт миграции - это утилита, не часть основного кода
2. Скрипт не запускается автоматически, только вручную
3. Скрипт не изменяет структуру БД, только данные

**Fallback-механизмы:**
- Скрипт не обязателен для работы системы
- Если скрипт не запущен, веса остаются равными 1.0 (работает, но не оптимально)
- Скрипт можно запустить в любое время

**Проверка перед релизом:**
- [ ] Скрипт запускается без ошибок
- [ ] Скрипт корректно пересчитывает веса
- [ ] Скрипт не ломает существующие данные
- [ ] Dry-run режим работает корректно

**Что НЕ сломается:**
- Основной код бота (скрипт отдельный)
- Выбор изображений (работает даже без пересчета весов)
- Голосование (работает как раньше)

**Примечание:** Скрипт рекомендуется запустить после задачи 1 для пересчета весов из истории, но не обязателен для работы системы.

## Связанные задачи
- Нет
