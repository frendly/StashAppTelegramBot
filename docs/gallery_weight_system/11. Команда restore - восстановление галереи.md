# 11. Команда /restore - восстановление галереи

**Приоритет:** Низкий (Команды управления)

## Описание
Реализация команды `/restore {gallery_id}` и обработчика кнопки восстановления для восстановления исключенной галереи.

## Требования из MVP
Формат вывода:
```
✅ Галерея "Название_галереи" восстановлена!

• Новый вес: 1.0
• Статус: активна
• Статистика сохранена: 12/20 (-60%)
```

## Задачи

### 11.1. Метод восстановления галереи
**Файл:** `bot/database.py`

Добавить метод:
- `restore_gallery(gallery_id)` - восстановление галереи
- Установить `excluded = FALSE`
- Установить `excluded_at = NULL`
- Сбросить вес до 1.0 (или сохранить предыдущий вес?)
- Сбросить `threshold_notification_shown = FALSE`
- Сохранить статистику (не удалять)

### 11.2. Обработчик команды /restore
**Файл:** `bot/telegram_handler.py`

Добавить метод:
- `restore_command(update, context)` - обработка команды `/restore {gallery_id}`
- Парсить gallery_id из аргументов команды
- Проверить, что галерея исключена
- Вызвать `database.restore_gallery(gallery_id)`
- Отправить сообщение подтверждения
- Инвалидировать кэш весов

### 11.3. Обработчик callback восстановления
**Файл:** `bot/telegram_handler.py`

Добавить метод:
- `handle_restore_gallery_callback(update, context)` - обработка нажатия кнопки восстановления
- Парсить `restore_gallery_{gallery_id}` из callback_data
- Вызвать `database.restore_gallery(gallery_id)`
- Обновить сообщение или отправить новое с подтверждением

### 11.4. Регистрация обработчиков
**Файл:** `bot/telegram_handler.py`

В `setup_handlers()`:
- Добавить `CommandHandler("restore", self.restore_command)`
- Добавить `CallbackQueryHandler` для паттерна `^restore_gallery_`

### 11.5. Форматирование сообщения подтверждения
**Файл:** `bot/telegram_handler.py`

Использовать формат из MVP:
- Название галереи
- Новый вес (1.0)
- Статус (активна)
- Сохраненная статистика

### 11.6. Обработка ошибок
**Файл:** `bot/telegram_handler.py`

Обработать случаи:
- Галерея не найдена
- Галерея не была исключена
- Неверный формат команды (нет gallery_id)

## Тестирование
- Проверить восстановление через команду `/restore {id}`
- Проверить восстановление через кнопку
- Проверить сброс веса до 1.0
- Проверить сброс флага уведомления
- Проверить, что галерея снова участвует в выборе
- Проверить обработку ошибок

## Зависимости
- Задача 1: Система весов галерей (метод restore)
- Задача 8: Кнопка исключения галереи
- Задача 10: Команда /excluded

## Безопасность релиза

### ✅ Можно релизить после этой задачи

**Условия для безопасного релиза:**
1. Команда работает только если есть исключенные галереи (задача 8)
2. Если галерея не была исключена, показывается сообщение об ошибке
3. Восстановление не удаляет данные, только снимает флаг `excluded`

**Fallback-механизмы:**
- Если галерея не найдена → показывается сообщение "Галерея не найдена"
- Если галерея не была исключена → показывается сообщение "Галерея не была исключена"
- Если произошла ошибка → показывается сообщение об ошибке

**Проверка перед релизом:**
- [ ] Бот запускается без ошибок
- [ ] Команда `/restore {gallery_id}` работает
- [ ] Восстановление через кнопку работает
- [ ] Если галерея не найдена, показывается корректное сообщение
- [ ] Восстановленная галерея снова участвует в выборе

**Что НЕ сломается:**
- Выбор изображений (восстановленные галереи снова доступны)
- Голосование (работает как раньше)
- Все остальные функции

## Связанные задачи
- Задача 9: Уведомления о достижении порога (сброс флага)
