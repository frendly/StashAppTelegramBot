# План улучшений проекта StashApp Telegram Bot

> Документ содержит план улучшений, оптимизаций и рефакторинга проекта

## 1. Тестирование

### 1.1 Добавление unit-тестов

- **Файлы для тестирования:**
  - `bot/database/` - репозитории (моки SQLite)
  - `bot/voting.py` - логика голосования
  - `bot/stash/selection.py` - взвешенный выбор галерей
  - `bot/handlers/caption_formatter.py` - форматирование подписей
  - `bot/config.py` - загрузка конфигурации

- **Инструменты:** pytest, pytest-asyncio, pytest-mock
- **Структура:** `tests/` директория с зеркальной структурой `bot/`
- **Покрытие:** Целевое покрытие 70%+ для критичных модулей
- **Статус:** выполнено — добавлены тесты для `bot/database/`, `bot/handlers/caption_formatter.py`, `bot/voting.py`, `bot/stash/selection.py`, `bot/config.py`

### 1.2 Добавление интеграционных тестов

- Тесты для полного flow `/random` команды
- Тесты для системы голосования
- Тесты для планировщика

### 1.3 CI/CD для тестов (не нужно делать)

- GitHub Actions workflow для запуска тестов
- Проверка покрытия кода (coverage.py)

## 2. Улучшение типизации

### 2.1 Строгая типизация (сделано)

- **Файлы для улучшения:**
  - `bot/telegram_handler.py` - убрать `TYPE_CHECKING` где возможно
  - `bot/handlers/photo_sender.py` - улучшить типы для `_prefetched_image`
  - `bot/database/__init__.py` - типизировать делегирование методов

### 2.2 Использование Protocol для абстракций

- Создать Protocol для Database интерфейса
- Protocol для StashClient интерфейса
- Упростит тестирование и мокирование

### 2.3 TypedDict для конфигурации

- Заменить dataclasses на TypedDict где уместно
- Улучшит валидацию конфигурации

## 3. Оптимизация производительности

### 3.1 Оптимизация кэширования

- **Файл:** `bot/voting.py`
- **Проблема:** Кэш фильтров и весов инвалидируется полностью
- **Решение:** Частичная инвалидация кэша (только измененные элементы)

### 3.2 Батчинг запросов к БД

- **Файлы:** `bot/database/preferences.py`, `bot/voting.py`
- Группировать множественные обновления предпочтений в батчи
- Использовать транзакции для атомарности

### 3.3 Оптимизация GraphQL запросов

- **Файл:** `bot/stash/image_service.py`
- Кэшировать результаты запросов на уровне сервиса
- Добавить connection pooling для aiohttp

### 3.4 Асинхронная работа с БД

- **Проблема:** SQLite синхронный, блокирует event loop
- **Решение:** Использовать `aiosqlite` для асинхронной работы с SQLite
- **Файлы:** Все файлы в `bot/database/`

## 4. Улучшение обработки ошибок

### 4.1 Стандартизация обработки ошибок

- Создать кастомные исключения в `bot/exceptions.py`:
  - `StashAppError`, `DatabaseError`, `TelegramError`, `ConfigError`
- Заменить generic `Exception` на специфичные типы

### 4.2 Retry декоратор

- **Файл:** `bot/utils/retry.py` (новый)
- Универсальный декоратор для retry логики
- Использовать в `bot/stash/client.py` вместо дублирования

### 4.3 Circuit Breaker паттерн

- Для StashApp API запросов
- Предотвращение каскадных сбоев при недоступности API

## 5. Рефакторинг

### 5.1 Улучшение делегирования в Database

- **Файл:** `bot/database/__init__.py`
- **Проблема:** Много ручного делегирования методов (100+ строк)
- **Решение:** Использовать `__getattr__` для автоматического делегирования

### 5.2 Выделение констант (сделано)

- **Файл:** `bot/constants.py` (новый)
- Вынести магические числа и строки:
  - TTL кэшей (60, 3600)
  - Веса галерей (1.2, 0.8, 0.1, 10.0)
  - Пороги исключения (33.3%)
  - Rate limits (2 секунды)

### 5.3 Упрощение зависимостей

- **Файл:** `bot/telegram_handler.py`
- Уменьшить количество параметров в конструкторах
- Использовать dependency injection контейнер (опционально)

## 6. Система миграций БД

### 6.1 Добавление миграций

- **Структура:** `migrations/` директория
- **Инструмент:** Alembic или собственная система миграций
- **Файлы:**
  - `migrations/versions/` - версии миграций
  - `bot/database/migrations.py` - утилиты для миграций

### 6.2 Автоматическое применение миграций

- При старте бота проверять и применять миграции
- Логировать примененные миграции

## 7. Улучшение конфигурации

### 7.1 Валидация конфигурации

- **Файл:** `bot/config.py`
- Использовать Pydantic для валидации
- Проверять корректность cron выражений
- Валидировать URL StashApp API

### 7.2 Переменные окружения

- Расширить поддержку переменных окружения
- Документировать все доступные переменные

## 8. Логирование и мониторинг

### 8.1 Структурированное логирование

- **Файл:** `bot/logging_config.py` (новый)
- Использовать JSON формат для production
- Добавить контекстные логи (request_id, user_id)

### 8.2 Метрики и мониторинг

- **Файл:** `bot/metrics.py` (новый)
- Счетчики: количество отправленных фото, голосов
- Таймеры: время ответа API, время отправки фото
- Экспорт метрик в Prometheus (опционально)

### 8.3 Health checks (сделано)

- **Файл:** `bot/health.py` (новый)
- Endpoint для проверки здоровья бота
- Проверка подключения к StashApp, БД, Telegram API

## 9. Документация

### 9.1 API документация

- Добавить docstrings для всех публичных методов
- Использовать Sphinx для генерации документации

### 9.2 Примеры использования

- Добавить примеры в README.md
- Создать `docs/EXAMPLES.md` с примерами конфигураций

### 9.3 Архитектурные диаграммы

- Обновить диаграммы в CURSOR.md
- Добавить sequence диаграммы для сложных flow

## 10. Безопасность

### 10.1 Улучшение валидации входных данных

- Валидация user_id в командах
- Санитизация данных из StashApp

### 10.2 Rate limiting улучшения

- Более гибкая настройка rate limits
- Разные лимиты для разных команд

### 10.3 Secrets management

- Использовать секреты из переменных окружения
- Предупреждения при использовании токенов в конфиге

## 11. Оптимизация зависимостей

### 11.1 Обновление зависимостей

- Проверить актуальные версии в `requirements.txt`
- Обновить с учетом совместимости

### 11.2 Анализ зависимостей

- Использовать `pip-audit` для проверки уязвимостей
- Минимизировать количество зависимостей

## 12. Код качество

### 12.1 Линтеры и форматтеры

- Настроить ruff для линтинга и форматирования
- Добавить pre-commit hooks
- Проверка в CI/CD

### 12.2 Type checking

- Использовать mypy для проверки типов
- Строгий режим для новых файлов

### 12.3 Code complexity

- Измерить сложность кода (cyclomatic complexity)
- Рефакторинг сложных методов

## Приоритизация

### Высокий приоритет

1. **Тестирование** (unit-тесты для критичных модулей)
2. **Асинхронная работа с БД** (aiosqlite)
3. **Улучшение обработки ошибок**
4. **Система миграций БД**

### Средний приоритет

5. Оптимизация кэширования
6. Улучшение типизации
7. Рефакторинг делегирования в Database
8. Валидация конфигурации

### Низкий приоритет

9. Метрики и мониторинг
10. API документация
11. Health checks
12. Архитектурные диаграммы

## Статус выполнения

- [ ] 1. Тестирование
- [ ] 2. Улучшение типизации
- [ ] 3. Оптимизация производительности
- [ ] 4. Улучшение обработки ошибок
- [ ] 5. Рефакторинг
- [ ] 6. Система миграций БД
- [ ] 7. Улучшение конфигурации
- [ ] 8. Логирование и мониторинг
- [ ] 9. Документация
- [ ] 10. Безопасность
- [ ] 11. Оптимизация зависимостей
- [ ] 12. Код качество

---

**Последнее обновление:** 2026-02-03
**Версия плана:** 1.0.0
