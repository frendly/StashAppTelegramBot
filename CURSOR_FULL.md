# StashApp Telegram Bot - –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏

> **–ì–ª–∞–≤–Ω—ã–π –¥–æ–∫—É–º–µ–Ω—Ç –¥–ª—è –ø–æ–Ω–∏–º–∞–Ω–∏—è –ø—Ä–æ–µ–∫—Ç–∞**  
> –ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ: 2026-01-30

---

## üìã –°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ

1. [–û–±–∑–æ—Ä –ø—Ä–æ–µ–∫—Ç–∞](#–æ–±–∑–æ—Ä-–ø—Ä–æ–µ–∫—Ç–∞)
2. [–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞](#–∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞)
3. [–°–∏—Å—Ç–µ–º–∞ –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏—è](#—Å–∏—Å—Ç–µ–º–∞-–≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏—è)
4. [–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∏ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏](#–ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å-–∏-–æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏)
5. [–ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç](#–±—ã—Å—Ç—Ä—ã–π-—Å—Ç–∞—Ä—Ç)
6. [–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞](#—Å—Ç—Ä—É–∫—Ç—É—Ä–∞-–ø—Ä–æ–µ–∫—Ç–∞)

---

## –û–±–∑–æ—Ä –ø—Ä–æ–µ–∫—Ç–∞

### –ß—Ç–æ —ç—Ç–æ

**StashApp Telegram Bot** - –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π Telegram –±–æ—Ç –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–ª—É—á–∞–π–Ω—ã—Ö —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π –∏–∑ –∫–æ–ª–ª–µ–∫—Ü–∏–∏ StashApp. –ü—Ä–æ–µ–∫—Ç —Ä–µ–∞–ª–∏–∑—É–µ—Ç –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—é –º–µ–∂–¥—É StashApp (—Å–∏—Å—Ç–µ–º–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –º–µ–¥–∏–∞–∫–æ–ª–ª–µ–∫—Ü–∏–µ–π) –∏ Telegram —Å –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç—É–∞–ª—å–Ω–æ–π —Å–∏—Å—Ç–µ–º–æ–π —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π –Ω–∞ –æ—Å–Ω–æ–≤–µ –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π.

### –û—Å–Ω–æ–≤–Ω—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏

- üì∏ **–û—Ç–ø—Ä–∞–≤–∫–∞ —Å–ª—É—á–∞–π–Ω—ã—Ö —Ñ–æ—Ç–æ** –ø–æ –∫–æ–º–∞–Ω–¥–µ `/random`
- ‚è∞ **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞ –ø–æ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—é** (–Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º—ã–π cron)
- üëçüëé **–°–∏—Å—Ç–µ–º–∞ –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏—è** —Å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ–º —Ä–µ–π—Ç–∏–Ω–≥–æ–≤ –≤ StashApp
- üéØ **–ò–Ω—Ç–µ–ª–ª–µ–∫—Ç—É–∞–ª—å–Ω–∞—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è** –Ω–∞ –æ—Å–Ω–æ–≤–µ –ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏–π (blacklist/whitelist)
- üîÑ **–ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏–µ –ø–æ–≤—Ç–æ—Ä–æ–≤** (–Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º—ã–π –ø–µ—Ä–∏–æ–¥)
- üìä **–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏ –ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏—è** (`/stats`, `/preferences`)
- üîê **–ö–æ–Ω—Ç—Ä–æ–ª—å –¥–æ—Å—Ç—É–ø–∞** –ø–æ whitelist Telegram ID
- üê≥ **–ü—Ä–æ—Å—Ç–æ–µ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ** —á–µ—Ä–µ–∑ Docker

### –¢–µ—Ö–Ω–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π —Å—Ç–µ–∫

**Backend:**
- Python 3.11+
- asyncio –¥–ª—è –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–≥–æ I/O
- aiohttp –¥–ª—è HTTP –∑–∞–ø—Ä–æ—Å–æ–≤
- python-telegram-bot 20.7 –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å Telegram API
- APScheduler 3.10.4 –¥–ª—è –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –∑–∞–¥–∞—á
- SQLite –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –∏—Å—Ç–æ—Ä–∏–∏ –∏ –ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏–π

**Deployment:**
- Docker –∏ Docker Compose
- –ü–æ–¥–¥–µ—Ä–∂–∫–∞ TrueNAS Scale, Ubuntu/Debian
- GitHub Container Registry –¥–ª—è CI/CD

---

## –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

### –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã —Å–∏—Å—Ç–µ–º—ã

```mermaid
graph TB
    User[Telegram User]
    Bot[Telegram Bot]
    
    subgraph BotComponents [Bot Components]
        Handler[telegram_handler.py<br/>Command Handlers]
        Scheduler[scheduler.py<br/>Cron Jobs]
        Voting[voting.py<br/>Vote Manager]
    end
    
    subgraph DataLayer [Data Layer]
        Database[database.py<br/>SQLite]
        StashClient[stash_client.py<br/>GraphQL Client]
    end
    
    subgraph External [External Services]
        StashApp[StashApp<br/>GraphQL API]
        TelegramAPI[Telegram API]
    end
    
    User -->|commands| Bot
    Bot --> Handler
    Handler --> Voting
    Handler --> Database
    Handler --> StashClient
    Scheduler --> Handler
    Voting --> Database
    Voting --> StashClient
    StashClient -->|GraphQL| StashApp
    Handler -->|send photos| TelegramAPI
    
    style Bot fill:#e1f5ff
    style BotComponents fill:#f0f0f0
    style DataLayer fill:#fff4e1
    style External fill:#e8f5e9
```

### –ú–æ–¥—É–ª–∏

#### 1. `bot/main.py` - –¢–æ—á–∫–∞ –≤—Ö–æ–¥–∞

**–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å:**
- –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –≤—Å–µ—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤
- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∂–∏–∑–Ω–µ–Ω–Ω—ã–º —Ü–∏–∫–ª–æ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
- Graceful shutdown
- –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è

**–û—Å–Ω–æ–≤–Ω–æ–π –∫–ª–∞—Å—Å:**
```python
class Bot:
    async def initialize()  # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤
    async def start()       # –ó–∞–ø—É—Å–∫ –±–æ—Ç–∞
    async def stop()        # –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –±–æ—Ç–∞
```

**–ü—Ä–æ—Ü–µ—Å—Å –∑–∞–ø—É—Å–∫–∞:**
```
–ó–∞–ø—É—Å–∫ ‚Üí –ó–∞–≥—Ä—É–∑–∫–∞ config.yml ‚Üí –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ë–î ‚Üí
‚Üí –°–æ–∑–¥–∞–Ω–∏–µ StashClient ‚Üí –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è VotingManager ‚Üí
‚Üí –°–æ–∑–¥–∞–Ω–∏–µ Telegram Application ‚Üí –ó–∞–ø—É—Å–∫ Scheduler ‚Üí
‚Üí Polling ‚Üí –û–∂–∏–¥–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è
```

#### 2. `bot/config.py` - –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–µ–π

**–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å:**
- –ó–∞–≥—Ä—É–∑–∫–∞ YAML –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
- –í–∞–ª–∏–¥–∞—Ü–∏—è –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤
- –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è

**Dataclasses:**
```python
@dataclass
class TelegramConfig:
    bot_token: str
    allowed_user_ids: List[int]

@dataclass
class StashConfig:
    api_url: str
    api_key: str

@dataclass
class SchedulerConfig:
    enabled: bool
    cron: str
    timezone: str

@dataclass
class HistoryConfig:
    avoid_recent_days: int

@dataclass
class DatabaseConfig:
    path: str

@dataclass
class BotConfig:
    telegram: TelegramConfig
    stash: StashConfig
    scheduler: SchedulerConfig
    history: HistoryConfig
    database: DatabaseConfig
```

#### 3. `bot/database.py` - –†–∞–±–æ—Ç–∞ —Å –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö

**–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å:**
- –•—Ä–∞–Ω–µ–Ω–∏–µ –∏—Å—Ç–æ—Ä–∏–∏ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã—Ö —Ñ–æ—Ç–æ
- –•—Ä–∞–Ω–µ–Ω–∏–µ –≥–æ–ª–æ—Å–æ–≤ –∏ –ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏–π
- –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏–µ –ø–æ–≤—Ç–æ—Ä–æ–≤
- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞

**–°—Ö–µ–º–∞ –ë–î:**

```sql
-- –ò—Å—Ç–æ—Ä–∏—è –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã—Ö —Ñ–æ—Ç–æ
CREATE TABLE sent_photos (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    image_id TEXT NOT NULL,
    sent_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    user_id INTEGER,
    title TEXT
);
CREATE INDEX idx_image_id ON sent_photos(image_id);
CREATE INDEX idx_sent_at ON sent_photos(sent_at);

-- –ì–æ–ª–æ—Å–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
CREATE TABLE votes (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    image_id TEXT NOT NULL,
    user_id INTEGER NOT NULL,
    vote INTEGER NOT NULL,  -- 1 (–ª–∞–π–∫) –∏–ª–∏ -1 (–¥–∏–∑–ª–∞–π–∫)
    voted_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    gallery_id TEXT,
    performer_ids TEXT,
    UNIQUE(image_id, user_id)
);

-- –ü—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏—è –ø–æ –ø–µ—Ä—Ñ–æ—Ä–º–µ—Ä–∞–º
CREATE TABLE performer_preferences (
    performer_id TEXT PRIMARY KEY,
    performer_name TEXT,
    positive_votes INTEGER DEFAULT 0,
    negative_votes INTEGER DEFAULT 0,
    total_votes INTEGER DEFAULT 0,
    score REAL DEFAULT 0.0,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- –ü—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏—è –ø–æ –≥–∞–ª–µ—Ä–µ—è–º
CREATE TABLE gallery_preferences (
    gallery_id TEXT PRIMARY KEY,
    gallery_title TEXT,
    positive_votes INTEGER DEFAULT 0,
    negative_votes INTEGER DEFAULT 0,
    total_votes INTEGER DEFAULT 0,
    score REAL DEFAULT 0.0,
    rating_set INTEGER DEFAULT 0,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

**–û—Å–Ω–æ–≤–Ω—ã–µ –º–µ—Ç–æ–¥—ã:**
- `add_sent_photo()` - –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –∑–∞–ø–∏—Å–∏ –æ–± –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω–æ–º —Ñ–æ—Ç–æ
- `get_recent_image_ids()` - –ø–æ–ª—É—á–µ–Ω–∏–µ –Ω–µ–¥–∞–≤–Ω–∏—Ö ID –¥–ª—è –∏—Å–∫–ª—é—á–µ–Ω–∏—è
- `add_vote()` - —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≥–æ–ª–æ—Å–∞
- `update_performer_preference()` - –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏–π –ø–µ—Ä—Ñ–æ—Ä–º–µ—Ä–∞
- `update_gallery_preference()` - –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏–π –≥–∞–ª–µ—Ä–µ–∏
- `get_blacklisted_performers/galleries()` - –ø–æ–ª—É—á–µ–Ω–∏–µ blacklist
- `get_whitelisted_performers/galleries()` - –ø–æ–ª—É—á–µ–Ω–∏–µ whitelist

#### 4. `bot/stash_client.py` - –ö–ª–∏–µ–Ω—Ç StashApp

**–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å:**
- –í–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ —Å StashApp GraphQL API
- –ü–æ–ª—É—á–µ–Ω–∏–µ —Å–ª—É—á–∞–π–Ω—ã—Ö –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π —Å —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–µ–π
- –°–∫–∞—á–∏–≤–∞–Ω–∏–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π (thumbnail/preview)
- –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ä–µ–π—Ç–∏–Ω–≥–æ–≤
- –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ API

**–û—Å–Ω–æ–≤–Ω—ã–µ –∫–ª–∞—Å—Å—ã:**

```python
@dataclass
class StashImage:
    id: str
    title: str
    rating: int
    image_url: str
    tags: List[str]
    gallery_id: Optional[str]
    gallery_title: Optional[str]
    performers: List[Dict[str, str]]

class StashClient:
    async def get_random_image()           # –ë–∞–∑–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å
    async def get_random_image_weighted()  # –° —É—á–µ—Ç–æ–º –ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏–π
    async def download_image()             # –°–∫–∞—á–∏–≤–∞–Ω–∏–µ
    async def update_image_rating()        # –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ä–µ–π—Ç–∏–Ω–≥–∞ —Ñ–æ—Ç–æ
    async def update_gallery_rating()      # –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ä–µ–π—Ç–∏–Ω–≥–∞ –≥–∞–ª–µ—Ä–µ–∏
```

**GraphQL –∑–∞–ø—Ä–æ—Å (—É–ø—Ä–æ—â–µ–Ω–Ω—ã–π):**

```graphql
query FindRandomImages($excludeIds: [ID!]) {
  findImages(
    image_filter: { id: { modifier: NOT_EQUALS, value: $excludeIds } }
    filter: { per_page: 20, sort: "random" }
  ) {
    images {
      id
      title
      rating100
      paths { thumbnail, preview, image }
      galleries { id, title }
      performers { id, name }
    }
  }
}
```

**–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏:**
- Async context manager –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è aiohttp —Å–µ—Å—Å–∏–µ–π
- Retry –ª–æ–≥–∏–∫–∞ –¥–ª—è –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç–∏ (–¥–æ 5 –ø–æ–ø—ã—Ç–æ–∫)
- Timeout: 30s total, 10s connect
- –ü–æ–¥–¥–µ—Ä–∂–∫–∞ API –∫–ª—é—á–µ–π
- –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç –∑–∞–≥—Ä—É–∑–∫–∏: thumbnail ‚Üí preview ‚Üí image

#### 5. `bot/telegram_handler.py` - –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–æ–º–∞–Ω–¥

**–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å:**
- –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–æ–º–∞–Ω–¥ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –ø–æ whitelist
- –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π
- –û—Ç–ø—Ä–∞–≤–∫–∞ —Ñ–æ—Ç–æ —Å –∫–Ω–æ–ø–∫–∞–º–∏ –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏—è
- –û–±—Ä–∞–±–æ—Ç–∫–∞ callback –æ—Ç –∫–Ω–æ–ø–æ–∫
- –ü—Ä–µ–¥–∑–∞–≥—Ä—É–∑–∫–∞ —Å–ª–µ–¥—É—é—â–µ–≥–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è (–æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è)

**–ö–æ–º–∞–Ω–¥—ã:**

| –ö–æ–º–∞–Ω–¥–∞ | –û–ø–∏—Å–∞–Ω–∏–µ |
|---------|----------|
| `/start` | –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ –∏ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ |
| `/help` | –°–ø—Ä–∞–≤–∫–∞ –ø–æ –∫–æ–º–∞–Ω–¥–∞–º –∏ —Å–∏—Å—Ç–µ–º–µ –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏—è |
| `/random` | –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–ª—É—á–∞–π–Ω–æ–≥–æ —Ñ–æ—Ç–æ (—Å –ø—Ä–µ–¥–∑–∞–≥—Ä—É–∑–∫–æ–π) |
| `/stats` | –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã—Ö —Ñ–æ—Ç–æ |
| `/preferences` | –¢–æ–ø-5 –ª—é–±–∏–º—ã—Ö/–Ω–µ–ª—é–±–∏–º—ã—Ö –ø–µ—Ä—Ñ–æ—Ä–º–µ—Ä–æ–≤ –∏ –≥–∞–ª–µ—Ä–µ–π |

**–ü–æ—Ç–æ–∫ –æ–±—Ä–∞–±–æ—Ç–∫–∏ `/random`:**

```
–ö–æ–º–∞–Ω–¥–∞ ‚Üí –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ ‚Üí 
‚Üí –ï—Å—Ç—å –ø—Ä–µ–¥–∑–∞–≥—Ä—É–∂–µ–Ω–Ω–æ–µ —Ñ–æ—Ç–æ? ‚Üí –î–ê ‚Üí –û—Ç–ø—Ä–∞–≤–∏—Ç—å –º–≥–Ω–æ–≤–µ–Ω–Ω–æ
                             ‚Üí –ù–ï–¢ ‚Üí –ü–æ–ª—É—á–∏—Ç—å –Ω–µ–¥–∞–≤–Ω–∏–µ ID –∏–∑ –ë–î ‚Üí
‚Üí –ü–æ–ª—É—á–∏—Ç—å filtering lists (blacklist/whitelist) ‚Üí
‚Üí –ó–∞–ø—Ä–æ—Å –∫ StashApp (weighted) ‚Üí –°–∫–∞—á–∏–≤–∞–Ω–∏–µ thumbnail ‚Üí
‚Üí –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ–¥–ø–∏—Å–∏ ‚Üí –û—Ç–ø—Ä–∞–≤–∫–∞ –≤ Telegram —Å –∫–Ω–æ–ø–∫–∞–º–∏ üëçüëé ‚Üí
‚Üí –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ –ë–î ‚Üí –ó–∞–ø—É—Å–∫ —Ñ–æ–Ω–æ–≤–æ–π –ø—Ä–µ–¥–∑–∞–≥—Ä—É–∑–∫–∏ —Å–ª–µ–¥—É—é—â–µ–≥–æ —Ñ–æ—Ç–æ
```

**–ü—Ä–µ–¥–∑–∞–≥—Ä—É–∑–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π:**
- –°–ª–µ–¥—É—é—â–µ–µ —Ñ–æ—Ç–æ –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è –≤ —Ñ–æ–Ω–æ–≤–æ–º —Ä–µ–∂–∏–º–µ –ø–æ—Å–ª–µ –æ—Ç–ø—Ä–∞–≤–∫–∏
- –ü–æ—Å–ª–µ–¥—É—é—â–∏–µ –∑–∞–ø—Ä–æ—Å—ã `/random` –∏—Å–ø–æ–ª—å–∑—É—é—Ç –∫—ç—à (~1 —Å–µ–∫ –≤–º–µ—Å—Ç–æ 8-13 —Å–µ–∫)
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –≤–∞–ª–∏–¥–∞—Ü–∏—è –∞–∫—Ç—É–∞–ª—å–Ω–æ—Å—Ç–∏ –∫—ç—à–∞

#### 6. `bot/scheduler.py` - –ü–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫

**–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å:**
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞ –ø–æ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—é
- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ cron –∑–∞–¥–∞—á–∞–º–∏
- –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –∑–æ–Ω

**–ò—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏:**
- APScheduler - –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ –∑–∞–¥–∞—á
- CronTrigger - cron –≤—ã—Ä–∞–∂–µ–Ω–∏—è
- pytz - –≤—Ä–µ–º–µ–Ω–Ω—ã–µ –∑–æ–Ω—ã

**–ü—Ä–∏–º–µ—Ä—ã cron:**
- `0 10 * * *` - –∫–∞–∂–¥—ã–π –¥–µ–Ω—å –≤ 10:00
- `0 9,21 * * *` - –∫–∞–∂–¥—ã–π –¥–µ–Ω—å –≤ 9:00 –∏ 21:00
- `0 */3 * * *` - –∫–∞–∂–¥—ã–µ 3 —á–∞—Å–∞

#### 7. `bot/voting.py` - –ú–µ–Ω–µ–¥–∂–µ—Ä –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏—è

**–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å:**
- –û–±—Ä–∞–±–æ—Ç–∫–∞ –≥–æ–ª–æ—Å–æ–≤ (üëç/üëé)
- –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ä–µ–π—Ç–∏–Ω–≥–æ–≤ –≤ StashApp
- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏—è–º–∏ –ø–æ –ø–µ—Ä—Ñ–æ—Ä–º–µ—Ä–∞–º/–≥–∞–ª–µ—Ä–µ—è–º
- –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Å–ø–∏—Å–∫–æ–≤ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ (blacklist/whitelist)
- –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ —Ñ–∏–ª—å—Ç—Ä–æ–≤ (TTL 60 —Å–µ–∫)

**–û—Å–Ω–æ–≤–Ω—ã–µ –º–µ—Ç–æ–¥—ã:**

```python
class VotingManager:
    async def process_vote(image, vote, user_id)
    # –ü–æ–ª–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –≥–æ–ª–æ—Å–∞:
    # 1. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ä–µ–π—Ç–∏–Ω–≥–∞ —Ñ–æ—Ç–æ (5 –¥–ª—è üëç, 1 –¥–ª—è üëé)
    # 2. –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≥–æ–ª–æ—Å–∞ –≤ –ë–î
    # 3. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏–π –ø–µ—Ä—Ñ–æ—Ä–º–µ—Ä–æ–≤
    # 4. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏–π –≥–∞–ª–µ—Ä–µ–∏
    # 5. –ê–≤—Ç–æ—É—Å—Ç–∞–Ω–æ–≤–∫–∞ —Ä–µ–π—Ç–∏–Ω–≥–∞ –≥–∞–ª–µ—Ä–µ–∏ –ø–æ—Å–ª–µ 5+ –≥–æ–ª–æ—Å–æ–≤
    
    def get_preferences_summary()
    # –¢–æ–ø-5 –ª—é–±–∏–º—ã—Ö/–Ω–µ–ª—é–±–∏–º—ã—Ö –ø–µ—Ä—Ñ–æ—Ä–º–µ—Ä–æ–≤ –∏ –≥–∞–ª–µ—Ä–µ–π
    
    def get_filtering_lists()
    # –°–ø–∏—Å–∫–∏ –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ (—Å –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ–º)
```

#### 8. `bot/performance.py` - –ü—Ä–æ—Ñ–∏–ª–∏—Ä–æ–≤–∞–Ω–∏–µ

**–£—Ç–∏–ª–∏—Ç—ã –¥–ª—è –∏–∑–º–µ—Ä–µ–Ω–∏—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏:**

```python
@timing_decorator  # –î–µ–∫–æ—Ä–∞—Ç–æ—Ä –¥–ª—è —Ñ—É–Ω–∫—Ü–∏–π
async def some_function():
    pass

with timing_context("Operation name"):  # –ö–æ–Ω—Ç–µ–∫—Å—Ç–Ω—ã–π –º–µ–Ω–µ–¥–∂–µ—Ä
    # code

timer = PerformanceTimer("Send photo")  # –î–µ—Ç–∞–ª—å–Ω—ã–π –ø—Ä–æ—Ñ–∞–π–ª–µ—Ä
timer.checkpoint("Stage 1")
timer.checkpoint("Stage 2")
timer.report()  # –í—ã–≤–æ–¥ –æ—Ç—á–µ—Ç–∞
```

### –ü–æ—Ç–æ–∫–∏ –¥–∞–Ω–Ω—ã—Ö

#### –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–ª—É—á–∞–π–Ω–æ–≥–æ —Ñ–æ—Ç–æ —Å –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏–µ–º

```mermaid
sequenceDiagram
    participant User
    participant Handler
    participant Database
    participant Voting
    participant StashClient
    participant StashApp
    participant TelegramAPI

    User->>Handler: /random
    Handler->>Handler: Check authorization
    Handler->>Database: get_recent_image_ids(30)
    Database-->>Handler: [recent IDs]
    Handler->>Voting: get_filtering_lists()
    Voting->>Database: get blacklist/whitelist
    Database-->>Voting: lists
    Voting-->>Handler: filtering_lists
    Handler->>StashClient: get_random_image_weighted()
    StashClient->>StashApp: GraphQL query
    StashApp-->>StashClient: random image data
    StashClient->>StashApp: download thumbnail
    StashApp-->>StashClient: image bytes
    StashClient-->>Handler: StashImage + bytes
    Handler->>TelegramAPI: send_photo with üëçüëé buttons
    TelegramAPI-->>User: photo with buttons
    Handler->>Database: add_sent_photo()
    Handler->>Handler: start prefetch next image (background)
    
    Note over User,TelegramAPI: User votes
    User->>Handler: Click üëç or üëé
    Handler->>Voting: process_vote(image, vote, user_id)
    Voting->>StashClient: update_image_rating(5 or 1)
    StashClient->>StashApp: GraphQL mutation
    Voting->>Database: add_vote()
    Voting->>Database: update_performer_preference()
    Voting->>Database: update_gallery_preference()
    Voting->>StashClient: update_gallery_rating (if threshold)
    Voting-->>Handler: result
    Handler->>TelegramAPI: update button (add ‚úì)
    Handler->>TelegramAPI: send result message
```

### –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

**Event Loop:**

```python
asyncio.run(main())
  ‚îú‚îÄ‚îÄ Bot.initialize()
  ‚îÇ   ‚îú‚îÄ‚îÄ load_config()
  ‚îÇ   ‚îú‚îÄ‚îÄ Database.__init__()
  ‚îÇ   ‚îú‚îÄ‚îÄ StashClient.__aenter__()
  ‚îÇ   ‚îú‚îÄ‚îÄ VotingManager.__init__()
  ‚îÇ   ‚îî‚îÄ‚îÄ Application.builder().build()
  ‚îÇ
  ‚îú‚îÄ‚îÄ Bot.start()
  ‚îÇ   ‚îú‚îÄ‚îÄ Scheduler.start()
  ‚îÇ   ‚îú‚îÄ‚îÄ Application.start()
  ‚îÇ   ‚îî‚îÄ‚îÄ Updater.start_polling()
  ‚îÇ
  ‚îî‚îÄ‚îÄ Bot.stop()
      ‚îú‚îÄ‚îÄ Scheduler.stop()
      ‚îú‚îÄ‚îÄ Application.shutdown()
      ‚îî‚îÄ‚îÄ StashClient.__aexit__()
```

**–ö–æ–Ω–∫—É—Ä–µ–Ω—Ç–Ω–æ—Å—Ç—å:**
- Telegram polling - –æ—Ç–¥–µ–ª—å–Ω—ã–π async task
- APScheduler - –∏–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω —Å asyncio event loop
- HTTP –∑–∞–ø—Ä–æ—Å—ã - aiohttp –¥–ª—è –Ω–µ–±–ª–æ–∫–∏—Ä—É—é—â–∏—Ö –æ–ø–µ—Ä–∞—Ü–∏–π
- –ü—Ä–µ–¥–∑–∞–≥—Ä—É–∑–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π - —Ñ–æ–Ω–æ–≤–∞—è –∑–∞–¥–∞—á–∞
- Database - —Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π (sqlite3), –Ω–æ –æ–ø–µ—Ä–∞—Ü–∏–∏ –±—ã—Å—Ç—Ä—ã–µ

### –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫

**–£—Ä–æ–≤–Ω–∏:**
1. **Telegram API errors** ‚Üí telegram_handler.py
2. **StashApp API errors** ‚Üí stash_client.py (retry –¥–æ 5 —Ä–∞–∑)
3. **Database errors** ‚Üí database.py
4. **Application errors** ‚Üí main.py (graceful shutdown)

**–°—Ç—Ä–∞—Ç–µ–≥–∏–∏:**
- **Retry** - –¥–ª—è HTTP –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ StashApp
- **Graceful degradation** - –±–æ—Ç –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç —Ä–∞–±–æ—Ç—É –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö
- **Logging** - –≤—Å–µ –æ—à–∏–±–∫–∏ –ª–æ–≥–∏—Ä—É—é—Ç—Å—è —Å –ø–æ–¥—Ä–æ–±–Ω–æ—Å—Ç—è–º–∏
- **User notification** - –ø–æ–Ω—è—Ç–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é

---

## –°–∏—Å—Ç–µ–º–∞ –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏—è

### –û–±–∑–æ—Ä

–ü–æ–ª–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏—è —Å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ–º —Ä–µ–π—Ç–∏–Ω–≥–æ–≤ –≤ StashApp –∏ –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç—É–∞–ª—å–Ω–æ–π —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–µ–π –∫–æ–Ω—Ç–µ–Ω—Ç–∞ –Ω–∞ –æ—Å–Ω–æ–≤–µ –ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π.

### –ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç

#### 1. –ì–æ–ª–æ—Å–æ–≤–∞–Ω–∏–µ –∑–∞ —Ñ–æ—Ç–æ

–ö–∞–∂–¥–æ–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω–æ–µ —Ñ–æ—Ç–æ –∏–º–µ–µ—Ç inline-–∫–Ω–æ–ø–∫–∏:
- üëç **–õ–∞–π–∫** - –ø–æ–Ω—Ä–∞–≤–∏–ª–æ—Å—å
- üëé **–î–∏–∑–ª–∞–π–∫** - –Ω–µ –ø–æ–Ω—Ä–∞–≤–∏–ª–æ—Å—å

#### 2. –û–±—Ä–∞–±–æ—Ç–∫–∞ –≥–æ–ª–æ—Å–∞

–ü—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏ –∫–Ω–æ–ø–∫–∏ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç:

```python
# –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ä–µ–π—Ç–∏–Ω–≥–∞ —Ñ–æ—Ç–æ –≤ StashApp
if vote == 1:  # –õ–∞–π–∫
    await stash_client.update_image_rating(image_id, rating=5)
else:  # –î–∏–∑–ª–∞–π–∫
    await stash_client.update_image_rating(image_id, rating=1)

# –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≥–æ–ª–æ—Å–∞ —Å –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–º
database.add_vote(
    image_id=image_id,
    user_id=user_id,
    vote=vote,
    gallery_id=image.gallery_id,
    performer_ids=image.performers
)

# –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏–π –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –ø–µ—Ä—Ñ–æ—Ä–º–µ—Ä–∞
for performer in image.performers:
    database.update_performer_preference(
        performer_id=performer['id'],
        performer_name=performer['name'],
        vote=vote
    )

# –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏–π –≥–∞–ª–µ—Ä–µ–∏
if image.gallery_id:
    database.update_gallery_preference(
        gallery_id=image.gallery_id,
        gallery_title=image.gallery_title,
        vote=vote
    )
```

#### 3. –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Ä–µ–π—Ç–∏–Ω–≥ –≥–∞–ª–µ—Ä–µ–∏

–ü–æ—Å–ª–µ –Ω–∞–∫–æ–ø–ª–µ–Ω–∏—è 5+ –≥–æ–ª–æ—Å–æ–≤ –∑–∞ —Ñ–æ—Ç–æ –∏–∑ –≥–∞–ª–µ—Ä–µ–∏:
- –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è –ø—Ä–æ—Ü–µ–Ω—Ç –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã—Ö –≥–æ–ª–æ—Å–æ–≤
- –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ—Ç—Å—è –≤ —Ä–µ–π—Ç–∏–Ω–≥ 1-5 –∑–≤–µ–∑–¥
- –†–µ–π—Ç–∏–Ω–≥ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è –≤ StashApp **–æ–¥–Ω–æ–∫—Ä–∞—Ç–Ω–æ**

**–§–æ—Ä–º—É–ª–∞:**
- 0-20% –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã—Ö ‚Üí ‚≠ê (1 –∑–≤–µ–∑–¥–∞)
- 20-40% ‚Üí ‚≠ê‚≠ê (2 –∑–≤–µ–∑–¥—ã)
- 40-60% ‚Üí ‚≠ê‚≠ê‚≠ê (3 –∑–≤–µ–∑–¥—ã)
- 60-80% ‚Üí ‚≠ê‚≠ê‚≠ê‚≠ê (4 –∑–≤–µ–∑–¥—ã)
- 80-100% ‚Üí ‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê (5 –∑–≤–µ–∑–¥)

### –°–∏—Å—Ç–µ–º–∞ –ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏–π

#### Score —Ñ–æ—Ä–º—É–ª–∞

```python
score = (positive_votes - negative_votes) / total_votes
```

**–î–∏–∞–ø–∞–∑–æ–Ω:** -1.0 (—Ç–æ–ª—å–∫–æ –¥–∏–∑–ª–∞–π–∫–∏) –¥–æ +1.0 (—Ç–æ–ª—å–∫–æ –ª–∞–π–∫–∏)

#### Blacklist (score < 0)

–ü–µ—Ä—Ñ–æ—Ä–º–µ—Ä—ã –∏ –≥–∞–ª–µ—Ä–µ–∏ —Å –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–º score:
- **–ü–æ–ª–Ω–æ—Å—Ç—å—é –∏—Å–∫–ª—é—á–∞—é—Ç—Å—è** –∏–∑ –≤—ã–¥–∞—á–∏
- –ò—Ö –∫–æ–Ω—Ç–µ–Ω—Ç –Ω–∏–∫–æ–≥–¥–∞ –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è

#### Whitelist (score > 0)

–ü–µ—Ä—Ñ–æ—Ä–º–µ—Ä—ã –∏ –≥–∞–ª–µ—Ä–µ–∏ —Å –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã–º score:
- **–ü—Ä–∏–æ—Ä–∏—Ç–∏–∑–∏—Ä—É—é—Ç—Å—è** –≤ –≤—ã–¥–∞—á–µ
- –ï—Å–ª–∏ –µ—Å—Ç—å whitelist, –∫–æ–Ω—Ç–µ–Ω—Ç –Ω–µ –∏–∑ –Ω–µ–≥–æ –ø—Ä–æ–ø—É—Å–∫–∞–µ—Ç—Å—è —Å –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å—é 50%

### –ö–æ–º–∞–Ω–¥–∞ `/preferences`

–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏–π:

```
üìä –í–∞—à–∏ –ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏—è

üë• –¢–æ–ø-5 –ª—é–±–∏–º—ã—Ö –ø–µ—Ä—Ñ–æ—Ä–º–µ—Ä–æ–≤:
1. Performer A (score: 0.85, 17 –ª–∞–π–∫–æ–≤, 3 –¥–∏–∑–ª–∞–π–∫–∞)
2. Performer B (score: 0.75, 12 –ª–∞–π–∫–æ–≤, 4 –¥–∏–∑–ª–∞–π–∫–∞)
...

üëé –¢–æ–ø-5 –Ω–µ–ª—é–±–∏–º—ã—Ö –ø–µ—Ä—Ñ–æ—Ä–º–µ—Ä–æ–≤:
1. Performer X (score: -0.60, 2 –ª–∞–π–∫–∞, 8 –¥–∏–∑–ª–∞–π–∫–æ–≤)
...

üìÅ –¢–æ–ø-5 –ª—é–±–∏–º—ã—Ö –≥–∞–ª–µ—Ä–µ–π:
...

üìÅ –¢–æ–ø-5 –Ω–µ–ª—é–±–∏–º—ã—Ö –≥–∞–ª–µ—Ä–µ–π:
...

üìà –û–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:
‚Ä¢ –í—Å–µ–≥–æ –≥–æ–ª–æ—Å–æ–≤: 45
‚Ä¢ –õ–∞–π–∫–æ–≤: 32 (71%)
‚Ä¢ –î–∏–∑–ª–∞–π–∫–æ–≤: 13 (29%)
```

### –ò–Ω—Ç–µ–ª–ª–µ–∫—Ç—É–∞–ª—å–Ω–∞—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è

–ü—Ä–∏ –∑–∞–ø—Ä–æ—Å–µ `/random` –±–æ—Ç:

1. **–ü–æ–ª—É—á–∞–µ—Ç —Å–ø–∏—Å–∫–∏ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏** (—Å –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ–º 60 —Å–µ–∫):
   - Blacklisted performers (score < 0)
   - Blacklisted galleries (score < 0)
   - Whitelisted performers (score > 0)
   - Whitelisted galleries (score > 0)

2. **–ó–∞–ø—Ä–∞—à–∏–≤–∞–µ—Ç 20 —Å–ª—É—á–∞–π–Ω—ã—Ö –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π** –∏–∑ StashApp

3. **–ü—Ä–∏–º–µ–Ω—è–µ—Ç —Ñ–∏–ª—å—Ç—Ä—ã:**
   - –ò—Å–∫–ª—é—á–∞–µ—Ç —Ñ–æ—Ç–æ —Å blacklisted performers/galleries
   - –ï—Å–ª–∏ –µ—Å—Ç—å whitelist - –ø—Ä–æ–ø—É—Å–∫–∞–µ—Ç 50% —Ñ–æ—Ç–æ –Ω–µ –∏–∑ whitelist
   - –ï—Å–ª–∏ –Ω–µ—Ç –ø–æ–¥—Ö–æ–¥—è—â–∏—Ö - retry (–¥–æ 5 –ø–æ–ø—ã—Ç–æ–∫)

4. **–û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Ñ–æ—Ç–æ** —Å —É—á–µ—Ç–æ–º –ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏–π

### –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ

–°–ø–∏—Å–∫–∏ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –∫—ç—à–∏—Ä—É—é—Ç—Å—è –Ω–∞ 60 —Å–µ–∫—É–Ω–¥:
- –£–º–µ–Ω—å—à–∞–µ—Ç –Ω–∞–≥—Ä—É–∑–∫—É –Ω–∞ –ë–î
- –ò–Ω–≤–∞–ª–∏–¥–∏—Ä—É–µ—Ç—Å—è –ø–æ—Å–ª–µ –∫–∞–∂–¥–æ–≥–æ –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏—è
- –õ–æ–≥–∏—Ä—É–µ—Ç—Å—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –∫—ç—à–∞

```python
# –õ–æ–≥–∏
‚è±Ô∏è  Using cached filtering lists (age: 45.2s)
# –∏–ª–∏
‚è±Ô∏è  Refreshing filtering lists cache
```

### –ì–ª–æ–±–∞–ª—å–Ω—ã–µ vs –ò–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã–µ –ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏—è

**–¢–µ–∫—É—â–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è:** –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏—è
- –í—Å–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –±–æ—Ç–∞ –¥–µ–ª—è—Ç –æ–±—â—É—é —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
- –ì–æ–ª–æ—Å–∞ –æ—Ç –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –≤–ª–∏—è—é—Ç –Ω–∞ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—é

**–í–æ–∑–º–æ–∂–Ω–æ–µ —É–ª—É—á—à–µ–Ω–∏–µ:** –ò–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã–µ –ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏—è
- –ö–∞–∂–¥—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∏–º–µ–µ—Ç —Å–≤–æ–∏ –ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏—è
- –¢—Ä–µ–±—É–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω–∏—è `user_id` –≤ performer_preferences –∏ gallery_preferences

---

## –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∏ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏

### –°–∏—Å—Ç–µ–º–∞ –ø—Ä–æ—Ñ–∏–ª–∏—Ä–æ–≤–∞–Ω–∏—è

#### –ú–æ–¥—É–ª—å `bot/performance.py`

–ü—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç —É—Ç–∏–ª–∏—Ç—ã –¥–ª—è –∏–∑–º–µ—Ä–µ–Ω–∏—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏:

```python
# 1. –î–µ–∫–æ—Ä–∞—Ç–æ—Ä –¥–ª—è —Ñ—É–Ω–∫—Ü–∏–π
@timing_decorator
async def expensive_operation():
    # –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ª–æ–≥–∏—Ä—É–µ—Ç –≤—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è
    pass

# 2. –ö–æ–Ω—Ç–µ–∫—Å—Ç–Ω—ã–π –º–µ–Ω–µ–¥–∂–µ—Ä
with timing_context("Download image"):
    image_data = await download()

# 3. –î–µ—Ç–∞–ª—å–Ω—ã–π –ø—Ä–æ—Ñ–∞–π–ª–µ—Ä
timer = PerformanceTimer("Send random photo")
timer.checkpoint("Get recent IDs")
# ... –æ–ø–µ—Ä–∞—Ü–∏–∏ ...
timer.checkpoint("Download image")
# ... –æ–ø–µ—Ä–∞—Ü–∏–∏ ...
timer.report()  # –ö—Ä–∞—Å–∏–≤—ã–π –æ—Ç—á–µ—Ç
```

#### –ü—Ä–∏–º–µ—Ä Performance Report

```
============================================================
‚è±Ô∏è  Performance Report: Send random photo
------------------------------------------------------------
  Get recent IDs from DB...................... 0.003s (  0.5%)
  Get filtering lists from DB................. 0.009s (  1.5%)
  Get random image (weighted)................. 0.455s ( 75.4%)
  Download image.............................. 0.120s ( 19.9%)
  Send to Telegram............................ 0.015s (  2.5%)
  Save to database............................ 0.002s (  0.3%)
------------------------------------------------------------
  TOTAL....................................... 0.604s (100.0%)
============================================================
```

### –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏

#### 1. –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ —Ñ–∏–ª—å—Ç—Ä–æ–≤

```python
# bot/voting.py
class VotingManager:
    def __init__(self, cache_ttl=60):
        self._filtering_cache = None
        self._cache_timestamp = None
        self._cache_ttl = cache_ttl
```

**–≠—Ñ—Ñ–µ–∫—Ç:** –≠–∫–æ–Ω–æ–º–∏—è ~0.01-0.02 —Å–µ–∫ –Ω–∞ –∫–∞–∂–¥—ã–π –∑–∞–ø—Ä–æ—Å –ø–æ—Å–ª–µ –ø–µ—Ä–≤–æ–≥–æ

#### 2. –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è GraphQL –∑–∞–ø—Ä–æ—Å–æ–≤

```python
# –ë—ã–ª–æ: 50 –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π + —Ç–µ–≥–∏
per_page: 50
tags { name }

# –°—Ç–∞–ª–æ: 20 –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –±–µ–∑ —Ç–µ–≥–æ–≤
per_page: 20
# tags —É–±—Ä–∞–Ω—ã
```

**–≠—Ñ—Ñ–µ–∫—Ç:** –£–º–µ–Ω—å—à–µ–Ω–∏–µ –æ–±—ä–µ–º–∞ –¥–∞–Ω–Ω—ã—Ö –Ω–∞ ~60%, —É—Å–∫–æ—Ä–µ–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–∞ –Ω–∞ 30-40%

#### 3. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ thumbnail –≤–º–µ—Å—Ç–æ preview

```python
# bot/stash_client.py
class StashImage:
    def __init__(self, data):
        paths = data.get('paths', {})
        # –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç: thumbnail ‚Üí preview ‚Üí image
        self.image_url = (
            paths.get('thumbnail') or 
            paths.get('preview') or 
            paths.get('image', '')
        )
```

**–≠—Ñ—Ñ–µ–∫—Ç:** 
- –†–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞: ~15-30 KB –≤–º–µ—Å—Ç–æ ~50-100 KB
- –°–∫–æ—Ä–æ—Å—Ç—å –∑–∞–≥—Ä—É–∑–∫–∏: 3-5x –±—ã—Å—Ç—Ä–µ–µ
- –°–∫–æ—Ä–æ—Å—Ç—å –æ—Ç–ø—Ä–∞–≤–∫–∏ –≤ Telegram: 3-5x –±—ã—Å—Ç—Ä–µ–µ

#### 4. –ü—Ä–µ–¥–∑–∞–≥—Ä—É–∑–∫–∞ —Å–ª–µ–¥—É—é—â–µ–≥–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è

```python
# bot/telegram_handler.py
async def _send_random_photo(self, ...):
    # –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø—Ä–µ–¥–∑–∞–≥—Ä—É–∂–µ–Ω–Ω–æ–µ, –µ—Å–ª–∏ –µ—Å—Ç—å
    if self._prefetched_image:
        if prefetched_image.id not in recent_ids:
            logger.info("‚ö° –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –ø—Ä–µ–¥–∑–∞–≥—Ä—É–∂–µ–Ω–Ω–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ")
            image = prefetched_image
            # ... –º–≥–Ω–æ–≤–µ–Ω–Ω–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞ ...
    
    # –ü–æ—Å–ª–µ –æ—Ç–ø—Ä–∞–≤–∫–∏ - –∑–∞–ø—É—Å–∫–∞–µ–º –ø—Ä–µ–¥–∑–∞–≥—Ä—É–∑–∫—É —Å–ª–µ–¥—É—é—â–µ–≥–æ
    asyncio.create_task(self._prefetch_next_image())
```

**–≠—Ñ—Ñ–µ–∫—Ç:**
- –ü–µ—Ä–≤—ã–π `/random`: 2-4 —Å–µ–∫ (—Å thumbnail)
- –ü–æ—Å–ª–µ–¥—É—é—â–∏–µ `/random`: ~1 —Å–µ–∫ (–∏–∑ –∫—ç—à–∞)
- –£–ª—É—á—à–µ–Ω–∏–µ: **8-13x –±—ã—Å—Ç—Ä–µ–µ**

**–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏:**
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –≤–∞–ª–∏–¥–∞—Ü–∏—è –∞–∫—Ç—É–∞–ª—å–Ω–æ—Å—Ç–∏ –∫—ç—à–∞
- –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —á–µ—Ä–µ–∑ asyncio.Lock
- –†–∞–±–æ—Ç–∞–µ—Ç —Ç–æ–ª—å–∫–æ –¥–ª—è –∫–æ–º–∞–Ω–¥—ã `/random` (–Ω–µ –¥–ª—è –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫–∞)

#### 5. Timeout –¥–ª—è HTTP –∑–∞–ø—Ä–æ—Å–æ–≤

```python
# bot/stash_client.py
timeout = aiohttp.ClientTimeout(
    total=30,    # –ú–∞–∫—Å–∏–º—É–º 30 —Å–µ–∫—É–Ω–¥ –Ω–∞ –≤–µ—Å—å –∑–∞–ø—Ä–æ—Å
    connect=10   # –ú–∞–∫—Å–∏–º—É–º 10 —Å–µ–∫—É–Ω–¥ –Ω–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ
)
self.session = aiohttp.ClientSession(timeout=timeout)
```

**–≠—Ñ—Ñ–µ–∫—Ç:** –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏–µ –∑–∞–≤–∏—Å–∞–Ω–∏–π –ø—Ä–∏ –ø—Ä–æ–±–ª–µ–º–∞—Ö —Å —Å–µ—Ç—å—é

### –ú–µ—Ç—Ä–∏–∫–∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏

#### –¶–µ–ª–µ–≤—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è

**–•–æ—Ä–æ—à–∞—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å:**
- –û–±—â–µ–µ –≤—Ä–µ–º—è: **< 3 —Å–µ–∫**
- GraphQL –∑–∞–ø—Ä–æ—Å: **< 0.5 —Å–µ–∫**
- –°–∫–∞—á–∏–≤–∞–Ω–∏–µ thumbnail: **< 0.2 —Å–µ–∫**
- –û—Ç–ø—Ä–∞–≤–∫–∞ –≤ Telegram: **< 0.5 —Å–µ–∫**

**–ü—Ä–∏–µ–º–ª–µ–º–∞—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å:**
- –û–±—â–µ–µ –≤—Ä–µ–º—è: **3-5 —Å–µ–∫**
- GraphQL –∑–∞–ø—Ä–æ—Å: **0.5-1.0 —Å–µ–∫**
- –°–∫–∞—á–∏–≤–∞–Ω–∏–µ thumbnail: **0.2-0.5 —Å–µ–∫**
- –û—Ç–ø—Ä–∞–≤–∫–∞ –≤ Telegram: **0.5-1.0 —Å–µ–∫**

**–¢—Ä–µ–±—É–µ—Ç –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏:**
- –û–±—â–µ–µ –≤—Ä–µ–º—è: **> 5 —Å–µ–∫** ‚ùå

#### –ê–Ω–∞–ª–∏–∑ —É–∑–∫–∏—Ö –º–µ—Å—Ç

**–ï—Å–ª–∏ "Get random image (weighted)" > 70%:**
- –ü—Ä–æ–±–ª–µ–º–∞: –ú–µ–¥–ª–µ–Ω–Ω—ã–π StashApp –∏–ª–∏ –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ retry
- –†–µ—à–µ–Ω–∏—è: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–µ—Ç—å, —É–º–µ–Ω—å—à–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã, –∏–Ω–¥–µ–∫—Å–∞—Ü–∏—è –≤ StashApp

**–ï—Å–ª–∏ "Download image" > 40%:**
- –ü—Ä–æ–±–ª–µ–º–∞: –ë–æ–ª—å—à–∏–µ preview
- –†–µ—à–µ–Ω–∏—è: –£–º–µ–Ω—å—à–∏—Ç—å —Ä–∞–∑–º–µ—Ä preview –≤ StashApp, –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å thumbnail

**–ï—Å–ª–∏ "Send to Telegram" > 30%:**
- –ü—Ä–æ–±–ª–µ–º–∞: –ú–µ–¥–ª–µ–Ω–Ω—ã–π –∏–Ω—Ç–µ—Ä–Ω–µ—Ç
- –†–µ—à–µ–Ω–∏—è: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ, —É–º–µ–Ω—å—à–∏—Ç—å —Ä–∞–∑–º–µ—Ä –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è

### –°—Ä–∞–≤–Ω–µ–Ω–∏–µ –¥–æ/–ø–æ—Å–ª–µ

| –ú–µ—Ç—Ä–∏–∫–∞ | –î–æ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–π | –ü–æ—Å–ª–µ | –£–ª—É—á—à–µ–Ω–∏–µ |
|---------|----------------|-------|-----------|
| GraphQL –∑–∞–ø—Ä–æ—Å | 0.5-0.8s | 0.3-0.5s | **30-40%** ‚ö° |
| –ó–∞–ø—Ä–æ—Å—ã –∫ –ë–î (2+ —Ä–∞–∑) | ~0.01s | ~0.001s | **90%** ‚ö° |
| –†–∞–∑–º–µ—Ä –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è | 50-100 KB | 15-30 KB | **3-5x** ‚ö° |
| –ü–µ—Ä–≤—ã–π `/random` | 8-13s | 2-4s | **3-4x** ‚ö° |
| –ü–æ—Å–ª–µ–¥—É—é—â–∏–µ `/random` | 8-13s | ~1s | **8-13x** ‚ö°‚ö° |

---

## –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç

### –ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω—ã–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è

- Python 3.11+ (–¥–ª—è –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ –∑–∞–ø—É—Å–∫–∞)
- Docker –∏ Docker Compose (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)
- –†–∞–±–æ—Ç–∞—é—â–∏–π —ç–∫–∑–µ–º–ø–ª—è—Ä StashApp
- Telegram Bot Token –æ—Ç [@BotFather](https://t.me/BotFather)

### 1. –°–æ–∑–¥–∞–Ω–∏–µ Telegram –±–æ—Ç–∞

```bash
# 1. –û—Ç–∫—Ä–æ–π—Ç–µ @BotFather –≤ Telegram
# 2. –û—Ç–ø—Ä–∞–≤—å—Ç–µ: /newbot
# 3. –°–ª–µ–¥—É–π—Ç–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è–º
# 4. –°–æ—Ö—Ä–∞–Ω–∏—Ç–µ —Ç–æ–∫–µ–Ω: 1234567890:ABCdef...
# 5. –£–∑–Ω–∞–π—Ç–µ —Å–≤–æ–π Telegram ID —á–µ—Ä–µ–∑ @userinfobot
```

### 2. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏

```bash
# –°–∫–æ–ø–∏—Ä—É–π—Ç–µ –ø—Ä–∏–º–µ—Ä –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
cp config.example.yml config.yml

# –û—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä—É–π—Ç–µ config.yml
```

**–ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è:**

```yaml
telegram:
  bot_token: "YOUR_BOT_TOKEN_HERE"
  allowed_user_ids:
    - 123456789  # –í–∞—à Telegram ID

stash:
  api_url: "http://localhost:9999/graphql"
  api_key: ""  # –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ

scheduler:
  enabled: true
  cron: "0 10 * * *"  # –ö–∞–∂–¥—ã–π –¥–µ–Ω—å –≤ 10:00
  timezone: "Europe/Moscow"

history:
  avoid_recent_days: 30

database:
  path: "/data/sent_photos.db"
```

### 3. –ó–∞–ø—É—Å–∫ —á–µ—Ä–µ–∑ Docker (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)

```bash
# –°–æ–∑–¥–∞–π—Ç–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –¥–ª—è –¥–∞–Ω–Ω—ã—Ö
mkdir -p data logs

# –ó–∞–ø—É—Å—Ç–∏—Ç–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
docker-compose up -d

# –ü—Ä–æ—Å–º–æ—Ç—Ä –ª–æ–≥–æ–≤
docker-compose logs -f
```

### 4. –ó–∞–ø—É—Å–∫ –ª–æ–∫–∞–ª—å–Ω–æ (–¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏)

```bash
# –°–æ–∑–¥–∞–π—Ç–µ –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ
python -m venv venv
source venv/bin/activate  # Linux/Mac
# –∏–ª–∏ venv\Scripts\activate  # Windows

# –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
pip install -r requirements.txt

# –ó–∞–ø—É—Å—Ç–∏—Ç–µ –±–æ—Ç–∞
python -m bot.main
```

### 5. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç—ã

–û—Ç–∫—Ä–æ–π—Ç–µ –≤–∞—à–µ–≥–æ –±–æ—Ç–∞ –≤ Telegram –∏ –æ—Ç–ø—Ä–∞–≤—å—Ç–µ:

```
/start      - –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ
/random     - –°–ª—É—á–∞–π–Ω–æ–µ —Ñ–æ—Ç–æ
/stats      - –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
```

### –ö–æ–º–∞–Ω–¥—ã —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è (Makefile)

```bash
make build    # –°–æ–±—Ä–∞—Ç—å Docker –æ–±—Ä–∞–∑
make up       # –ó–∞–ø—É—Å—Ç–∏—Ç—å –±–æ—Ç
make down     # –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –±–æ—Ç
make logs     # –ü—Ä–æ—Å–º–æ—Ç—Ä –ª–æ–≥–æ–≤
make restart  # –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å
make backup   # –†–µ–∑–µ—Ä–≤–Ω–∞—è –∫–æ–ø–∏—è –ë–î
make stats    # –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏–∑ –ë–î
make shell    # –í–æ–π—Ç–∏ –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
```

### –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ StashApp –≤ Docker

–ï—Å–ª–∏ StashApp —É–∂–µ –∑–∞–ø—É—â–µ–Ω –≤ Docker, –¥–æ–±–∞–≤—å—Ç–µ –±–æ—Ç–∞ –≤ —Ç—É –∂–µ —Å–µ—Ç—å:

```yaml
# docker-compose.yml
services:
  stash-telegram-bot:
    # ...
    networks:
      - stash-network

networks:
  stash-network:
    external: true
    name: stash_default  # –ò–º—è —Å–µ—Ç–∏ StashApp
```

---

## –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞

```
stash-telegram-bot/
‚îú‚îÄ‚îÄ bot/                          # –ò—Å—Ö–æ–¥–Ω—ã–π –∫–æ–¥
‚îÇ   ‚îú‚îÄ‚îÄ __init__.py              # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø–∞–∫–µ—Ç–∞
‚îÇ   ‚îú‚îÄ‚îÄ main.py                  # –¢–æ—á–∫–∞ –≤—Ö–æ–¥–∞ (228 —Å—Ç—Ä–æ–∫)
‚îÇ   ‚îú‚îÄ‚îÄ config.py                # –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–µ–π (107 —Å—Ç—Ä–æ–∫)
‚îÇ   ‚îú‚îÄ‚îÄ database.py              # –†–∞–±–æ—Ç–∞ —Å SQLite –ë–î (164 —Å—Ç—Ä–æ–∫–∏)
‚îÇ   ‚îú‚îÄ‚îÄ stash_client.py          # GraphQL –∫–ª–∏–µ–Ω—Ç StashApp (465 —Å—Ç—Ä–æ–∫)
‚îÇ   ‚îú‚îÄ‚îÄ telegram_handler.py      # –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ Telegram –∫–æ–º–∞–Ω–¥ (304 —Å—Ç—Ä–æ–∫–∏)
‚îÇ   ‚îú‚îÄ‚îÄ scheduler.py             # –ü–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ –æ—Ç–ø—Ä–∞–≤–∫–∏ (131 —Å—Ç—Ä–æ–∫–∞)
‚îÇ   ‚îú‚îÄ‚îÄ voting.py                # –ú–µ–Ω–µ–¥–∂–µ—Ä –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏—è (–Ω–æ–≤–æ–µ)
‚îÇ   ‚îî‚îÄ‚îÄ performance.py           # –£—Ç–∏–ª–∏—Ç—ã –ø—Ä–æ—Ñ–∏–ª–∏—Ä–æ–≤–∞–Ω–∏—è (–Ω–æ–≤–æ–µ)
‚îÇ
‚îú‚îÄ‚îÄ data/                        # –î–∞–Ω–Ω—ã–µ (–Ω–µ –≤ git)
‚îÇ   ‚îî‚îÄ‚îÄ sent_photos.db          # SQLite –±–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö
‚îÇ
‚îú‚îÄ‚îÄ logs/                        # –õ–æ–≥–∏ (–Ω–µ –≤ git)
‚îÇ   ‚îî‚îÄ‚îÄ bot.log                 # –§–∞–π–ª –ª–æ–≥–æ–≤
‚îÇ
‚îú‚îÄ‚îÄ docs/                        # –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è
‚îÇ   ‚îú‚îÄ‚îÄ DEPLOYMENT.md           # –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –ø–æ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—é
‚îÇ   ‚îî‚îÄ‚îÄ GITHUB_REGISTRY.md      # –†–∞–±–æ—Ç–∞ —Å GitHub Container Registry
‚îÇ
‚îú‚îÄ‚îÄ Dockerfile                   # Docker –æ–±—Ä–∞–∑
‚îú‚îÄ‚îÄ docker-compose.yml          # –û—Ä–∫–µ—Å—Ç—Ä–∞—Ü–∏—è –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤
‚îú‚îÄ‚îÄ docker-compose.ghcr.yml    # –í–∞—Ä–∏–∞–Ω—Ç —Å GHCR
‚îú‚îÄ‚îÄ requirements.txt            # Python –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
‚îú‚îÄ‚îÄ config.example.yml          # –ü—Ä–∏–º–µ—Ä –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
‚îú‚îÄ‚îÄ config.yml                  # –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è (–Ω–µ –≤ git)
‚îú‚îÄ‚îÄ Makefile                    # –ö–æ–º–∞–Ω–¥—ã —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
‚îú‚îÄ‚îÄ .gitignore                  # Git ignore –ø—Ä–∞–≤–∏–ª–∞
‚îú‚îÄ‚îÄ .dockerignore               # Docker ignore –ø—Ä–∞–≤–∏–ª–∞
‚îú‚îÄ‚îÄ README.md                   # –û—Å–Ω–æ–≤–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è
‚îú‚îÄ‚îÄ CHANGELOG.md                # –ò—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π
‚îî‚îÄ‚îÄ CURSOR.md                   # –≠—Ç–æ—Ç —Ñ–∞–π–ª ‚≠ê
```

### –û–ø–∏—Å–∞–Ω–∏–µ –º–æ–¥—É–ª–µ–π

| –ú–æ–¥—É–ª—å | –°—Ç—Ä–æ–∫ | –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ |
|--------|-------|------------|
| `main.py` | 228 | –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è, –∑–∞–ø—É—Å–∫, graceful shutdown |
| `config.py` | 107 | –ó–∞–≥—Ä—É–∑–∫–∞ –∏ –≤–∞–ª–∏–¥–∞—Ü–∏—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ |
| `database.py` | 164 | SQLite: –∏—Å—Ç–æ—Ä–∏—è, –≥–æ–ª–æ—Å–∞, –ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏—è |
| `stash_client.py` | 465 | GraphQL API, –∑–∞–≥—Ä—É–∑–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π |
| `telegram_handler.py` | 304 | –ö–æ–º–∞–Ω–¥—ã, –æ—Ç–ø—Ä–∞–≤–∫–∞ —Ñ–æ—Ç–æ, callback |
| `scheduler.py` | 131 | –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞ –ø–æ cron |
| `voting.py` | 200+ | –ì–æ–ª–æ—Å–æ–≤–∞–Ω–∏–µ, –ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏—è, —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è |
| `performance.py` | 168 | –ü—Ä–æ—Ñ–∏–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –º–µ—Ç—Ä–∏–∫–∏ |

**–í—Å–µ–≥–æ:** ~1700 —Å—Ç—Ä–æ–∫ –∫–æ–¥–∞

### –û—Å–Ω–æ–≤–Ω—ã–µ –∫–ª–∞—Å—Å—ã –∏ —Ñ—É–Ω–∫—Ü–∏–∏

```python
# bot/main.py
class Bot:
    async def initialize()
    async def start()
    async def stop()

# bot/config.py
@dataclass class BotConfig
def load_config(path) -> BotConfig

# bot/database.py
class Database:
    def add_sent_photo()
    def get_recent_image_ids()
    def add_vote()
    def update_performer_preference()
    # ... + 10+ –º–µ—Ç–æ–¥–æ–≤

# bot/stash_client.py
@dataclass class StashImage
class StashClient:
    async def get_random_image()
    async def get_random_image_weighted()
    async def download_image()
    async def update_image_rating()
    # ... + 5+ –º–µ—Ç–æ–¥–æ–≤

# bot/telegram_handler.py
class TelegramHandler:
    async def start_command()
    async def random_command()
    async def stats_command()
    async def preferences_command()
    async def handle_vote_callback()
    async def _send_random_photo()
    async def _prefetch_next_image()
    # ... + 5+ –º–µ—Ç–æ–¥–æ–≤

# bot/scheduler.py
class PhotoScheduler:
    def start()
    def stop()

# bot/voting.py
class VotingManager:
    async def process_vote()
    def get_preferences_summary()
    def get_filtering_lists()

# bot/performance.py
@timing_decorator
with timing_context()
class PerformanceTimer
```

### –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ (requirements.txt)

```txt
python-telegram-bot==20.7  # Telegram API
aiohttp==3.9.1            # Async HTTP client
APScheduler==3.10.4       # –ü–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ –∑–∞–¥–∞—á
PyYAML==6.0.1             # YAML –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
python-dotenv==1.0.0      # .env –ø–æ–¥–¥–µ—Ä–∂–∫–∞
```

### –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã

| –§–∞–π–ª | –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ |
|------|------------|
| `config.yml` | –û—Å–Ω–æ–≤–Ω–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è (—Ç–æ–∫–µ–Ω—ã, —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ, –Ω–∞—Å—Ç—Ä–æ–π–∫–∏) |
| `.env` | –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ) |
| `docker-compose.yml` | –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è Docker –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤ |
| `Dockerfile` | –û–ø–∏—Å–∞–Ω–∏–µ Docker –æ–±—Ä–∞–∑–∞ |
| `.gitignore` | –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º—ã–µ —Ñ–∞–π–ª—ã (config.yml, data/, logs/) |

---

## –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ä–µ—Å—É—Ä—Å—ã

### –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

- **README.md** - Getting started, –æ—Å–Ω–æ–≤–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è
- **CHANGELOG.md** - –ò—Å—Ç–æ—Ä–∏—è –≤–µ—Ä—Å–∏–π –∏ –∏–∑–º–µ–Ω–µ–Ω–∏–π
- **docs/DEPLOYMENT.md** - –î–µ—Ç–∞–ª—å–Ω—ã–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –ø–æ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—é
- **docs/GITHUB_REGISTRY.md** - CI/CD —á–µ—Ä–µ–∑ GitHub Container Registry

### –ü–æ–ª–µ–∑–Ω—ã–µ —Å—Å—ã–ª–∫–∏

- [python-telegram-bot Documentation](https://docs.python-telegram-bot.org/)
- [StashApp Documentation](https://github.com/stashapp/stash)
- [APScheduler Documentation](https://apscheduler.readthedocs.io/)
- [Docker Documentation](https://docs.docker.com/)

### –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

- ‚úÖ Whitelist –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –ø–æ Telegram ID
- ‚úÖ –¢–æ–∫–µ–Ω—ã –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è
- ‚úÖ –ù–µ–ø—Ä–∏–≤–∏–ª–µ–≥–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤ Docker
- ‚úÖ Read-only –º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
- ‚úÖ –ò–∑–æ–ª—è—Ü–∏—è –≤ Docker —Å–µ—Ç–∏
- ‚úÖ Rate limiting –¥–ª—è –∫–æ–º–∞–Ω–¥ (10 —Å–µ–∫ –º–µ–∂–¥—É `/random`)

### –ö–∞—á–µ—Å—Ç–≤–æ –∫–æ–¥–∞

- ‚úÖ Type hints –¥–ª—è –≤—Å–µ—Ö —Ñ—É–Ω–∫—Ü–∏–π
- ‚úÖ Docstrings –¥–ª—è –≤—Å–µ—Ö –ø—É–±–ª–∏—á–Ω—ã—Ö –º–µ—Ç–æ–¥–æ–≤
- ‚úÖ –°–ª–µ–¥–æ–≤–∞–Ω–∏–µ PEP 8
- ‚úÖ Async/await best practices
- ‚úÖ Proper error handling
- ‚úÖ Comprehensive logging
- ‚úÖ Performance monitoring

---

## –í–µ—Ä—Å–∏—è –¥–æ–∫—É–º–µ–Ω—Ç–∞

**–í–µ—Ä—Å–∏—è:** 1.0.0  
**–î–∞—Ç–∞:** 2026-01-30  
**–ê–≤—Ç–æ—Ä:** –ö–æ–Ω—Å–æ–ª–∏–¥–∞—Ü–∏—è –∏–∑ ARCHITECTURE.md, VOTING_SYSTEM.md, PERFORMANCE_ANALYSIS.md

**–°—Ç–∞—Ç—É—Å:** ‚úÖ Production Ready

---

*–≠—Ç–æ—Ç –¥–æ–∫—É–º–µ–Ω—Ç —è–≤–ª—è–µ—Ç—Å—è –≥–ª–∞–≤–Ω—ã–º –∏—Å—Ç–æ—á–Ω–∏–∫–æ–º —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –ø—Ä–æ–µ–∫—Ç–µ –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ –∏ –∫–æ–Ω—Ç—Ä–∏–±—å—é—Ç–æ—Ä–æ–≤.*
